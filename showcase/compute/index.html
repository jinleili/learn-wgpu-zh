<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Compute Example: Tangents and Bitangents | 学习 wgpu</title><meta name="description" content="使用 Rust 学习 wgpu">
    <link rel="preload" href="/learn-wgpu-zh/assets/js/runtime~app.eddb320c.js" as="script"><link rel="preload" href="/learn-wgpu-zh/assets/css/styles.f5314d33.css" as="style"><link rel="preload" href="/learn-wgpu-zh/assets/js/9141.74699445.js" as="script"><link rel="preload" href="/learn-wgpu-zh/assets/js/app.e6e110eb.js" as="script"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2d69bb60.73d1bc3a.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-bfc81dd6.d27a6749.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-4249d10f.168320d2.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-82a25e06.ac0552ad.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2168b6f4.120e0fbc.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-1d87647f.380079ee.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-5ffceace.a38085d7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2c95ce4.199bde74.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-5d0cc617.90e7871b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-627538dd.5689954d.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-220b0cd1.b710ff21.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-64802336.5a3e0ae3.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-31840cac.d512b48a.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b117cf7e.60a4adbf.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1162.2ea6707c.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/3475.a809e012.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5883.5147f7d5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7937.ce4c90cb.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1426.87fee456.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2307.a4b1569f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/381.14108687.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/662.1adc6c1b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b3ccb192.0d4e3260.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2277.bf1af19b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4970.5aae0d9f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5137.72720074.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-0440027a.54ebe8e8.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2b11540d.8a75cd2e.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-1f0489a3.0194b9cf.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-7db95cc0.4a15b3ac.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-25d83dbe.3d7765b6.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/6321.2154bf48.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5421.ea0a9875.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4839.38de57f2.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/416.263c3017.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2922.07ac6f22.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4607.4c710cc5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1769.a6f87e60.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7854.4bf820b5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7255.ec42f8b1.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5734.0dce093b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/6402.6d66210a.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/9292.fb0e80aa.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-1821b0a7.55122dad.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2a9f5e8.96dea684.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4204.63b46fe4.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-6b60e296.f8358226.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2a9f626.f5f8d691.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-8daa1a0e.609b00aa.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-8b4c6ddc.f0eea1c7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/9944.efbaf280.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-afc761bc.2ad5e887.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2076.158ecac5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-3706649a.a69da219.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/75.ccb1e0c7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/css/9253.styles.173ab900.css"><link rel="prefetch" href="/learn-wgpu-zh/assets/css/1610.styles.a289f906.css">
    <link rel="stylesheet" href="/learn-wgpu-zh/assets/css/styles.f5314d33.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/learn-wgpu-zh/" class=""><!----><span class="site-name">学习 wgpu</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/learn-wgpu-zh/showcase/compute/" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://sotrh.github.io/learn-wgpu/" rel="noopener noreferrer" target="_blank" aria-label="English"><!--[--><!--]--> English <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/jinleili/learn-wgpu-zh" rel="noopener noreferrer" target="_blank" aria-label="《Learn wgpu》中文版"><!--[--><!--]--> 《Learn wgpu》中文版 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/learn-wgpu-zh/showcase/compute/" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://sotrh.github.io/learn-wgpu/" rel="noopener noreferrer" target="_blank" aria-label="English"><!--[--><!--]--> English <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/jinleili/learn-wgpu-zh" rel="noopener noreferrer" target="_blank" aria-label="《Learn wgpu》中文版"><!--[--><!--]--> 《Learn wgpu》中文版 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/learn-wgpu-zh/" class="sidebar-item sidebar-heading" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading">基础 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/beginner/tutorial1-window/" class="sidebar-item" aria-label="依赖与窗口"><!--[--><!--]--> 依赖与窗口 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial2-surface/" class="sidebar-item" aria-label="展示平面 (Surface)"><!--[--><!--]--> 展示平面 (Surface) <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial3-pipeline/" class="sidebar-item" aria-label="管线 (Pipeline)"><!--[--><!--]--> 管线 (Pipeline) <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial4-buffer/" class="sidebar-item" aria-label="缓冲区与索引"><!--[--><!--]--> 缓冲区与索引 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial5-textures/" class="sidebar-item" aria-label="纹理和绑定组"><!--[--><!--]--> 纹理和绑定组 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial6-uniforms/" class="sidebar-item" aria-label="Uniform 缓冲区与 3D 虚拟摄像机"><!--[--><!--]--> Uniform 缓冲区与 3D 虚拟摄像机 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial7-instancing/" class="sidebar-item" aria-label="实例化绘制"><!--[--><!--]--> 实例化绘制 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial8-depth/" class="sidebar-item" aria-label="深度缓冲区"><!--[--><!--]--> 深度缓冲区 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial9-models/" class="sidebar-item" aria-label="模型加载"><!--[--><!--]--> 模型加载 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">进阶 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/intermediate/tutorial10-lighting/" class="sidebar-item" aria-label="光照"><!--[--><!--]--> 光照 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/tutorial11-normals/" class="sidebar-item" aria-label="法线映射"><!--[--><!--]--> 法线映射 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/tutorial12-camera/" class="sidebar-item" aria-label="更好的摄像机"><!--[--><!--]--> 更好的摄像机 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/xcode/" class="sidebar-item" aria-label="🆕 使用 Xcode 调试 wgpu 程序"><!--[--><!--]--> 🆕 使用 Xcode 调试 wgpu 程序 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">案例展示 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/showcase/windowless/" class="sidebar-item" aria-label="离屏渲染"><!--[--><!--]--> 离屏渲染 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/gifs/" class="sidebar-item" aria-label="生成 GIF 动图"><!--[--><!--]--> 生成 GIF 动图 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/pong/" class="sidebar-item" aria-label="Pong"><!--[--><!--]--> Pong <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/showcase/compute/" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Compute Example: Tangents and Bitangents"><!--[--><!--]--> Compute Example: Tangents and Bitangents <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/learn-wgpu-zh/showcase/compute/#possible-improvements" class="router-link-active router-link-exact-active sidebar-item" aria-label="Possible Improvements"><!--[--><!--]--> Possible Improvements <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/showcase/compute/#results" class="router-link-active router-link-exact-active sidebar-item" aria-label="Results"><!--[--><!--]--> Results <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/learn-wgpu-zh/showcase/alignment/" class="sidebar-item" aria-label="Memory Layout in WGSL"><!--[--><!--]--> Memory Layout in WGSL <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/imgui-demo/" class="sidebar-item" aria-label="Basic Imgui Demo"><!--[--><!--]--> Basic Imgui Demo <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/learn-wgpu-zh/GLOSSARY_OF_TERMS.html" class="sidebar-item sidebar-heading" aria-label="术语中英对照表"><!--[--><!--]--> 术语中英对照表 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="compute-example-tangents-and-bitangents" tabindex="-1"><a class="header-anchor" href="#compute-example-tangents-and-bitangents" aria-hidden="true">#</a> Compute Example: Tangents and Bitangents</h1><p>This proved more difficult than I anticipated. The first problem I encountered was some vertex data corruption due to the shader reading my vertex data incorrectly. I was using the <code>ModelVertex</code> struct I used in the <a href="/intermediate/tutorial11-normals/" target="_blank" rel="noopener noreferrer">normal mapping tutorial<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, Debug, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ModelVertex</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    normal<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tangent<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    bitangent<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This structure works perfectly fine when used as a vertex buffer. Using it as a storage buffer proved less convenient. My previous code used a GLSL struct similar to my <code>ModelVertex</code>.</p><div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">struct</span> <span class="token class-name">ModelVertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> tex_coords<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> normal<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> tangent<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> bitangent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>At first glance, this seems just fine, but OpenGL experts would likely see a problem with the structure. Our fields aren&#39;t aligned properly to support the <code>std430</code> alignment that storage buffers require. I won&#39;t get into detail but you can check out the <a href="../alignment">alignment showcase</a> if you want to know more. To summarize, the <code>vec2</code> for the <code>tex_coords</code> was messing up the byte alignment, corrupting the vertex data resulting in the following:</p><p><img src="/learn-wgpu-zh/assets/img/corruption.4d0cd631.png" alt="./corruption.png"></p><p>I could have fixed this by adding a padding field after <code>tex_coords</code> on the Rust side, but that would require modifying the <code>VertexBufferLayout</code>. I ended up solving this problem by using the components of the vectors directly which resulted in a struct like this:</p><div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">struct</span> <span class="token class-name">ModelVertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">float</span> x<span class="token punctuation">;</span> <span class="token keyword">float</span> y<span class="token punctuation">;</span> <span class="token keyword">float</span> z<span class="token punctuation">;</span>
    <span class="token keyword">float</span> uv<span class="token punctuation">;</span> <span class="token keyword">float</span> uw<span class="token punctuation">;</span>
    <span class="token keyword">float</span> nx<span class="token punctuation">;</span> <span class="token keyword">float</span> ny<span class="token punctuation">;</span> <span class="token keyword">float</span> nz<span class="token punctuation">;</span>
    <span class="token keyword">float</span> tx<span class="token punctuation">;</span> <span class="token keyword">float</span> ty<span class="token punctuation">;</span> <span class="token keyword">float</span> tz<span class="token punctuation">;</span>
    <span class="token keyword">float</span> bx<span class="token punctuation">;</span> <span class="token keyword">float</span> by<span class="token punctuation">;</span> <span class="token keyword">float</span> bz<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Since <code>std430</code> will use the alignment of the largest element of the struct, using all floats means the struct will be aligned to 4 bytes. This is alignment matches what <code>ModelVertex</code> uses in Rust. This was kind of a pain to work with, but it fixed the corruption issue.</p><p>The second problem required me to rethink how I was computing the tangent and bitangent. The previous algorithm I was using only computed the tangent and bitangent for each triangle and set all the vertices in that triangle to use the same tangent and bitangent. While this is fine in a single-threaded context, the code breaks down when trying to compute the triangles in parallel. The reason is that multiple triangles can share the same vertices. This means that when we go to save the resulting tangents, we inevitably end up trying to write to the same vertex from multiple different threads which is a big no no. You can see the issue with this method below:</p><p><img src="/learn-wgpu-zh/assets/img/black_triangles.5867e2e9.png" alt="./black_triangles.png"></p><p>Those black triangles were the result of multiple GPU threads trying to modify the same vertices. Looking at the data in Render Doc I could see that the tangents and bitangents were garbage numbers such as <code>NaN</code>.</p><p><img src="/learn-wgpu-zh/assets/img/render_doc_output.d2409f81.png" alt="./render_doc_output.png"></p><p>While on the CPU we could introduce a synchronization primitive such as a <code>Mutex</code> to fix this issue, AFAIK there isn&#39;t really such a thing on the GPU. Instead, I decided to swap my code to work with each vertex individually. There are some hurdles with that, but those will be easier to explain in code. Let&#39;s start with the <code>main</code> function.</p><div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint</span> vertexIndex <span class="token operator">=</span> gl_GlobalInvocationID<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    ModelVertex result <span class="token operator">=</span> <span class="token function">calcTangentBitangent</span><span class="token punctuation">(</span>vertexIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dstVertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We use the <code>gl_GlobalInvocationID.x</code> to get the index of the vertex we want to compute the tangents for. I opted to put the actual calculation into its own method. Let&#39;s take a look at that.</p><div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code>ModelVertex <span class="token function">calcTangentBitangent</span><span class="token punctuation">(</span><span class="token keyword">uint</span> vertexIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ModelVertex v <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> tangent <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> bitangent <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint</span> trianglesIncluded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// Find the triangles that use v</span>
    <span class="token comment">//  * Loop over every triangle (i + 3)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numIndices<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">uint</span> index0 <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">uint</span> index1 <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">uint</span> index2 <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Only perform the calculation if one of the indices</span>
        <span class="token comment">// matches our vertexIndex</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index0 <span class="token operator">==</span> vertexIndex <span class="token operator">||</span> index1 <span class="token operator">==</span> vertexIndex <span class="token operator">||</span> index2 <span class="token operator">==</span> vertexIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ModelVertex v0 <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>index0<span class="token punctuation">]</span><span class="token punctuation">;</span>
            ModelVertex v1 <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>index1<span class="token punctuation">]</span><span class="token punctuation">;</span>
            ModelVertex v2 <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>index2<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">vec3</span> pos0 <span class="token operator">=</span> <span class="token function">getPos</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> pos1 <span class="token operator">=</span> <span class="token function">getPos</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> pos2 <span class="token operator">=</span> <span class="token function">getPos</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">vec2</span> uv0 <span class="token operator">=</span> <span class="token function">getUV</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec2</span> uv1 <span class="token operator">=</span> <span class="token function">getUV</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec2</span> uv2 <span class="token operator">=</span> <span class="token function">getUV</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">vec3</span> delta_pos1 <span class="token operator">=</span> pos1 <span class="token operator">-</span> pos0<span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> delta_pos2 <span class="token operator">=</span> pos2 <span class="token operator">-</span> pos0<span class="token punctuation">;</span>

            <span class="token keyword">vec2</span> delta_uv1 <span class="token operator">=</span> uv1 <span class="token operator">-</span> uv0<span class="token punctuation">;</span>
            <span class="token keyword">vec2</span> delta_uv2 <span class="token operator">=</span> uv2 <span class="token operator">-</span> uv0<span class="token punctuation">;</span>

            <span class="token keyword">float</span> r <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>delta_uv1<span class="token punctuation">.</span>x <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>y <span class="token operator">-</span> delta_uv1<span class="token punctuation">.</span>y <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tangent <span class="token operator">+=</span> <span class="token punctuation">(</span>delta_pos1 <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>y <span class="token operator">-</span> delta_pos2 <span class="token operator">*</span> delta_uv1<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
            bitangent <span class="token operator">+=</span> <span class="token punctuation">(</span>delta_pos2 <span class="token operator">*</span> delta_uv1<span class="token punctuation">.</span>x <span class="token operator">-</span> delta_pos1 <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span> 
            trianglesIncluded <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>

    <span class="token comment">// Average the tangent and bitangents</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trianglesIncluded <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tangent <span class="token operator">/=</span> trianglesIncluded<span class="token punctuation">;</span>
        bitangent <span class="token operator">/=</span> trianglesIncluded<span class="token punctuation">;</span>
        tangent <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>tangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bitangent <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>bitangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Save the results</span>
    v<span class="token punctuation">.</span>tx <span class="token operator">=</span> tangent<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>ty <span class="token operator">=</span> tangent<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>tz <span class="token operator">=</span> tangent<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>bx <span class="token operator">=</span> bitangent<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>by <span class="token operator">=</span> bitangent<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>bz <span class="token operator">=</span> bitangent<span class="token punctuation">.</span>z<span class="token punctuation">;</span>

    <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="possible-improvements" tabindex="-1"><a class="header-anchor" href="#possible-improvements" aria-hidden="true">#</a> Possible Improvements</h2><p>Looping over every triangle for every vertex is likely raising some red flags for some of you. In a single-threaded context, this algorithm would end up being O(N*M). As we are utilizing the high number of threads available to our GPU, this is less of an issue, but it still means our GPU is burning more cycles than it needs to.</p><p>One way I came up with to possibly improve performance is to store the index of each triangle in a hash map like structure with the vertex index as keys. Here&#39;s some pseudo code:</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>indices<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token punctuation">{</span>
    triangle_map<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>t <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle_map<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>indices<span class="token punctuation">[</span>t <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle_map<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>indices<span class="token punctuation">[</span>t <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We&#39;d then need to flatten this structure to pass it to the GPU. We&#39;d also need a second array to index the first.</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span>_v<span class="token punctuation">,</span> t_list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> triangle_map<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    triangle_map_indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">TriangleMapIndex</span> <span class="token punctuation">{</span> 
        start<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
        len<span class="token punctuation">:</span> t_list<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flat_triangle_map<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>t_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>I ultimately decided against this method as it was more complicated, and I haven&#39;t had time to benchmark it to see if it&#39;s faster than the simple method.</p><h2 id="results" tabindex="-1"><a class="header-anchor" href="#results" aria-hidden="true">#</a> Results</h2><p>The tangents and bitangents are now getting calculated correctly and on the GPU!</p><p><img src="/learn-wgpu-zh/assets/img/results.59325691.png" alt="./results.png"></p><div class="auto-github-link"><a href="https://github.com/jinleili/learn-wgpu-zh/tree/master/code/showcase/compute/" target="_blank" rel="noopener noreferrer"> &quot;查看源码！&quot; </a><!----></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/learn-wgpu-zh/showcase/pong/" class="" aria-label="Pong"><!--[--><!--]--> Pong <!--[--><!--]--></a></span><span class="next"><a href="/learn-wgpu-zh/showcase/alignment/" class="" aria-label="Memory Layout in WGSL"><!--[--><!--]--> Memory Layout in WGSL <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/learn-wgpu-zh/assets/js/runtime~app.eddb320c.js" defer></script><script src="/learn-wgpu-zh/assets/js/9141.74699445.js" defer></script><script src="/learn-wgpu-zh/assets/js/app.e6e110eb.js" defer></script>
  </body>
</html>
