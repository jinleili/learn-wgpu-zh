<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Memory Layout in WGSL | 学习 wgpu</title><meta name="description" content="使用 Rust 学习 wgpu">
    <link rel="preload" href="/learn-wgpu-zh/assets/js/runtime~app.da394f90.js" as="script"><link rel="preload" href="/learn-wgpu-zh/assets/css/styles.f5314d33.css" as="style"><link rel="preload" href="/learn-wgpu-zh/assets/js/9141.74699445.js" as="script"><link rel="preload" href="/learn-wgpu-zh/assets/js/app.7a8054bf.js" as="script"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2d69bb60.4ad7e3d5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-bfc81dd6.7610dd06.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-4249d10f.c8f08817.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-82a25e06.36227ce7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2168b6f4.082f69c8.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-1d87647f.7013bab7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-5ffceace.798009a5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2c95ce4.cd4e566f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-5d0cc617.32ce7bdf.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-627538dd.522e9dbf.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-220b0cd1.77e47817.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-64802336.4bd624e8.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-31840cac.52f72f62.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b117cf7e.f771a00f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1162.2ea6707c.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/3475.a809e012.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5883.5147f7d5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7937.ce4c90cb.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1426.87fee456.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2307.a4b1569f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/381.14108687.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/662.1adc6c1b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b3ccb192.66c258ab.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2277.bf1af19b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4970.5aae0d9f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5137.72720074.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-0440027a.2a7be179.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2b11540d.ce61c40a.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-1f0489a3.40efb4d9.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-7db95cc0.8067cf73.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-25d83dbe.21b8ce4e.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/6321.2154bf48.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5421.ea0a9875.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4839.38de57f2.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/416.263c3017.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2922.07ac6f22.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4607.4c710cc5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1769.a6f87e60.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7854.4bf820b5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7255.ec42f8b1.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5734.0dce093b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/6402.6d66210a.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/9292.fb0e80aa.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2a9f5e8.70cbf4c7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4204.63b46fe4.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-6b60e296.6e133223.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2a9f626.1e209a62.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-8daa1a0e.254e2e03.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-8b4c6ddc.9dddfbb2.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/9944.efbaf280.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-afc761bc.82f0088e.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2076.158ecac5.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-3706649a.a69da219.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/75.ccb1e0c7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/css/9253.styles.173ab900.css"><link rel="prefetch" href="/learn-wgpu-zh/assets/css/1610.styles.a289f906.css">
    <link rel="stylesheet" href="/learn-wgpu-zh/assets/css/styles.f5314d33.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/learn-wgpu-zh/" class=""><!----><span class="site-name">学习 wgpu</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/learn-wgpu-zh/showcase/alignment/" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://sotrh.github.io/learn-wgpu/" rel="noopener noreferrer" target="_blank" aria-label="English"><!--[--><!--]--> English <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/jinleili/learn-wgpu-zh" rel="noopener noreferrer" target="_blank" aria-label="《Learn wgpu》中文版"><!--[--><!--]--> 《Learn wgpu》中文版 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/learn-wgpu-zh/showcase/alignment/" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://sotrh.github.io/learn-wgpu/" rel="noopener noreferrer" target="_blank" aria-label="English"><!--[--><!--]--> English <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/jinleili/learn-wgpu-zh" rel="noopener noreferrer" target="_blank" aria-label="《Learn wgpu》中文版"><!--[--><!--]--> 《Learn wgpu》中文版 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/learn-wgpu-zh/" class="sidebar-item sidebar-heading" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading">基础 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/beginner/tutorial1-window/" class="sidebar-item" aria-label="依赖与窗口"><!--[--><!--]--> 依赖与窗口 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial2-surface/" class="sidebar-item" aria-label="展示平面 (Surface)"><!--[--><!--]--> 展示平面 (Surface) <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial3-pipeline/" class="sidebar-item" aria-label="管线 (Pipeline)"><!--[--><!--]--> 管线 (Pipeline) <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial4-buffer/" class="sidebar-item" aria-label="缓冲区与索引"><!--[--><!--]--> 缓冲区与索引 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial5-textures/" class="sidebar-item" aria-label="纹理和绑定组"><!--[--><!--]--> 纹理和绑定组 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial6-uniforms/" class="sidebar-item" aria-label="Uniform 缓冲区与 3D 虚拟摄像机"><!--[--><!--]--> Uniform 缓冲区与 3D 虚拟摄像机 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial7-instancing/" class="sidebar-item" aria-label="实例化绘制"><!--[--><!--]--> 实例化绘制 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial8-depth/" class="sidebar-item" aria-label="深度缓冲区"><!--[--><!--]--> 深度缓冲区 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial9-models/" class="sidebar-item" aria-label="模型加载"><!--[--><!--]--> 模型加载 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">进阶 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/intermediate/tutorial10-lighting/" class="sidebar-item" aria-label="光照"><!--[--><!--]--> 光照 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/tutorial11-normals/" class="sidebar-item" aria-label="法线映射"><!--[--><!--]--> 法线映射 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/tutorial12-camera/" class="sidebar-item" aria-label="更好的摄像机"><!--[--><!--]--> 更好的摄像机 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/tutorial13-terrain/" class="sidebar-item" aria-label="程序地形"><!--[--><!--]--> 程序地形 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">案例展示 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/showcase/windowless/" class="sidebar-item" aria-label="Wgpu without a window"><!--[--><!--]--> Wgpu without a window <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/gifs/" class="sidebar-item" aria-label="Creating gifs"><!--[--><!--]--> Creating gifs <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/pong/" class="sidebar-item" aria-label="Pong"><!--[--><!--]--> Pong <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/compute/" class="sidebar-item" aria-label="Compute Example: Tangents and Bitangents"><!--[--><!--]--> Compute Example: Tangents and Bitangents <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/showcase/alignment/" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Memory Layout in WGSL"><!--[--><!--]--> Memory Layout in WGSL <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/learn-wgpu-zh/showcase/alignment/#alignment-of-vertex-and-index-buffers" class="router-link-active router-link-exact-active sidebar-item" aria-label="Alignment of vertex and index buffers"><!--[--><!--]--> Alignment of vertex and index buffers <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/showcase/alignment/#alignment-of-uniform-and-storage-buffers" class="router-link-active router-link-exact-active sidebar-item" aria-label="Alignment of Uniform and Storage buffers"><!--[--><!--]--> Alignment of Uniform and Storage buffers <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/showcase/alignment/#how-to-deal-with-alignment-issues" class="router-link-active router-link-exact-active sidebar-item" aria-label="How to deal with alignment issues"><!--[--><!--]--> How to deal with alignment issues <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/showcase/alignment/#additional-resources" class="router-link-active router-link-exact-active sidebar-item" aria-label="Additional resources"><!--[--><!--]--> Additional resources <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/learn-wgpu-zh/showcase/imgui-demo/" class="sidebar-item" aria-label="Basic Imgui Demo"><!--[--><!--]--> Basic Imgui Demo <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/learn-wgpu-zh/GLOSSARY_OF_TERMS.html" class="sidebar-item sidebar-heading" aria-label="术语中英对照表"><!--[--><!--]--> 术语中英对照表 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="memory-layout-in-wgsl" tabindex="-1"><a class="header-anchor" href="#memory-layout-in-wgsl" aria-hidden="true">#</a> Memory Layout in WGSL</h1><div class="warn"><p>This page is currently being reworked. I want to understand the topics a bit better, but as 0.12 is out I want to release what I have for now.</p></div><h2 id="alignment-of-vertex-and-index-buffers" tabindex="-1"><a class="header-anchor" href="#alignment-of-vertex-and-index-buffers" aria-hidden="true">#</a> Alignment of vertex and index buffers</h2><p>Vertex buffers require defining a <code>VertexBufferLayout</code>, so the memory alignment is whatever you tell WebGPU it should be. This can be really convenient for keeping down memory usage on the GPU.</p><p>The Index Buffer uses the alignment of whatever primitive type you specify via the <code>IndexFormat</code> you pass into <code>RenderEncoder::set_index_buffer()</code>.</p><h2 id="alignment-of-uniform-and-storage-buffers" tabindex="-1"><a class="header-anchor" href="#alignment-of-uniform-and-storage-buffers" aria-hidden="true">#</a> Alignment of Uniform and Storage buffers</h2><p>GPUs are designed to process thousands of pixels in parallel. In order to achieve this, some sacrifices had to be made. Graphics hardware likes to have all the bytes you intend on processing aligned by powers of 2. The exact specifics of why this is are beyond my level of knowledge, but it&#39;s important to know so that you can troubleshoot why your shaders aren&#39;t working.</p><!-- The address of the position of an instance in memory has to be a multiple of its alignment. Normally alignment is the same as size. Exceptions are vec3, structs, and arrays. A vec3 is padded to be a vec4 which means it behaves as if it was a vec4 just that the last entry is not used. --><p>Let&#39;s take a look at the following table:</p><hr><table><thead><tr><th>Type</th><th>Alignment in Bytes</th><th>Size in Bytes</th></tr></thead><tbody><tr><td>scalar (i32, u32, f32)</td><td>4</td><td>4</td></tr><tr><td>vec2&lt;T&gt;</td><td>8</td><td>8</td></tr><tr><td>vec3&lt;T&gt;</td><td><strong>16</strong></td><td>12</td></tr><tr><td>vec4&lt;T&gt;</td><td>16</td><td>16</td></tr></tbody></table><p>You can see for <code>vec3</code> the alignment is the next power of 2 from the size, 16. This can catch beginners (and even veterans) off guard as it&#39;s not the most intuitive. This becomes especially important when we start laying out structs. Take the light struct from the <a href="/learn-wgpu-zh/intermediate/tutorial10-lighting/#seeing-the-light" class="">lighting tutorial</a>:</p><p>You can see the full table of the alignments in section <a href="https://www.w3.org/TR/WGSL/#alignment-and-size" target="_blank" rel="noopener noreferrer">4.3.7.1 of the WGSL spec<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-wgsl ext-wgsl line-numbers-mode"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">Light</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    color<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>So what&#39;s the alignment of this struct? Your first guess would be that it&#39;s the sum of the alignments of the individual fields. That might make sense if we were in Rust-land, but in shader-land, it&#39;s a little more involved. The alignment for a given struct is given by the following equation:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// S is the struct in question
// M is a member of the struct
AlignOf(S) = max(AlignOfMember(S, M1), ... , AlignOfMember(S, Mn))
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Basically, the alignment of the struct is the maximum of the alignments of the members of the struct. This means that:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>AlignOf(Light) 
    = max(AlignOfMember(Light, position), AlignOfMember(Light, color))
    = max(16, 16)
    = 16
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This is why the <code>LightUniform</code> has those padding fields. WGPU won&#39;t accept it if the data is not aligned correctly.</p><h2 id="how-to-deal-with-alignment-issues" tabindex="-1"><a class="header-anchor" href="#how-to-deal-with-alignment-issues" aria-hidden="true">#</a> How to deal with alignment issues</h2><p>In general, 16 is the max alignment you&#39;ll see. In that case, you might think that we should be able to do something like the following:</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C, align(16))]</span>
<span class="token attribute attr-name">#[derive(Debug, Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">LightUniform</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>But this won&#39;t compile. The <a href="https://docs.rs/bytemuck/" target="_blank" rel="noopener noreferrer">bytemuck crate<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> doesn&#39;t work with structs with implicit padding bytes. Rust can&#39;t guarantee that the memory between the fields has been initialized properly. This gave me an error when I tried it:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>error[E0512]: cannot transmute between types of different sizes, or dependently-sized types
   --&gt; code/intermediate/tutorial10-lighting/src/main.rs:246:8
    |
246 | struct LightUniform {
    |        ^^^^^^^^^^^^
    |
    = note: source type: `LightUniform` (256 bits)
    = note: target type: `_::{closure#0}::TypeWithoutPadding` (192 bits)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="additional-resources" tabindex="-1"><a class="header-anchor" href="#additional-resources" aria-hidden="true">#</a> Additional resources</h2><p>If you&#39;re looking for more information check out the <a href="https://gist.github.com/teoxoy/936891c16c2a3d1c3c5e7204ac6cd76c" target="_blank" rel="noopener noreferrer">write-up<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> by @teoxoy.</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/learn-wgpu-zh/showcase/compute/" class="" aria-label="Compute Example: Tangents and Bitangents"><!--[--><!--]--> Compute Example: Tangents and Bitangents <!--[--><!--]--></a></span><span class="next"><a href="/learn-wgpu-zh/showcase/imgui-demo/" class="" aria-label="Basic Imgui Demo"><!--[--><!--]--> Basic Imgui Demo <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/learn-wgpu-zh/assets/js/runtime~app.da394f90.js" defer></script><script src="/learn-wgpu-zh/assets/js/9141.74699445.js" defer></script><script src="/learn-wgpu-zh/assets/js/app.7a8054bf.js" defer></script>
  </body>
</html>
