"use strict";(self.webpackChunklearn_wgpu_zh=self.webpackChunklearn_wgpu_zh||[]).push([[3272],{7005:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p=JSON.parse('{"key":"v-627538dd","path":"/showcase/windowless/","title":"离屏渲染","lang":"zh-CN","frontmatter":{},"excerpt":"","headers":[{"level":2,"title":"如何使用？","slug":"如何使用","link":"#如何使用","children":[]},{"level":2,"title":"离屏绘制一个三角形","slug":"离屏绘制一个三角形","link":"#离屏绘制一个三角形","children":[]},{"level":2,"title":"从缓冲区中读取数据","slug":"从缓冲区中读取数据","link":"#从缓冲区中读取数据","children":[]},{"level":2,"title":"Main 函数不能异步化","slug":"main-函数不能异步化","link":"#main-函数不能异步化","children":[]}],"git":{"updatedTime":1665022431000},"filePathRelative":"showcase/windowless/README.md"}')},4259:(n,s,a)=>{a.r(s),a.d(s,{default:()=>Y});var p=a(6252);const t=(0,p.uE)('<h1 id="离屏渲染" tabindex="-1"><a class="header-anchor" href="#离屏渲染" aria-hidden="true">#</a> 离屏渲染</h1><p>有时我们只是想利用 gpu，也许是要并行地计算一组大的数字; 也许是正在制作一部 3D 电影，并需要用路径追踪来创建一个看起来很真实的场景; 也许正在挖掘一种加密货币。在所有这些情况下，我们可能 <em>不需要</em> 从窗口看到正在发生的事情。</p><h2 id="如何使用" tabindex="-1"><a class="header-anchor" href="#如何使用" aria-hidden="true">#</a> 如何使用？</h2><p><strong>离屏渲染</strong>（Off-Screen Rendering, 也叫做 Windowless Rendering）其实很简单：事实上，我们不<em>需要</em>一个<strong>窗口</strong>（Window）来创建一个<strong>GPU 实例</strong>，不<em>需要</em>一个窗口来选择<strong>适配器</strong>，也不<em>需要</em>一个窗口来创建<strong>逻辑设备</strong>。我们只需要窗口来创建一个<strong>展示平面</strong>及<strong>交换链</strong>（SwapChain）。所以，只要有了<strong>逻辑设备</strong>，就可以开始向 GPU 发送命令。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> adapter <span class="token operator">=</span> instance\n    <span class="token punctuation">.</span><span class="token function">request_adapter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RequestAdapterOptions</span> <span class="token punctuation">{</span>\n        power_preference<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PowerPreference</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        compatible_surface<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token keyword">await</span>\n    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">)</span> <span class="token operator">=</span> adapter\n    <span class="token punctuation">.</span><span class="token function">request_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token keyword">await</span>\n    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="离屏绘制一个三角形" tabindex="-1"><a class="header-anchor" href="#离屏绘制一个三角形" aria-hidden="true">#</a> 离屏绘制一个三角形</h2>',6),e={href:"/beginner/tutorial2-surface/#render",target:"_blank",rel:"noopener noreferrer"},c=(0,p._)("code",null,"surface.get_current_texture()",-1),o=(0,p.uE)('<p>现在，我们跳过这一步，自己创建纹理。这里需要注意的是，需要指定 <code>TextureFormat::Rgba8UnormSrgb</code> 为纹理像素格式而不是 <code>surface.get_preferred_format(&amp;adapter)</code>，因为 PNG 使用 RGBA 而不是 BGRA 像素格式：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> texture_size <span class="token operator">=</span> <span class="token number">256u32</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> texture_desc <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDescriptor</span> <span class="token punctuation">{</span>\n    size<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Extent3d</span> <span class="token punctuation">{</span>\n        width<span class="token punctuation">:</span> texture_size<span class="token punctuation">,</span>\n        height<span class="token punctuation">:</span> texture_size<span class="token punctuation">,</span>\n        depth_or_array_layers<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    mip_level_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba8UnormSrgb</span><span class="token punctuation">,</span>\n    usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">COPY_SRC</span>\n        <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span>\n        <span class="token punctuation">,</span>\n    label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> texture <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_texture</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>texture_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> texture_view <span class="token operator">=</span> texture<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>usage 字段的 <code>RENDER_ATTACHMENT</code> 位令 wgpu 可以渲染到此纹理，<code>COPY_SRC</code> 位令我们能够从纹理中提取数据，以便能够将其保存到文件中。</p>',3),l={href:"/beginner/tutorial5-textures/",target:"_blank",rel:"noopener noreferrer"},u=(0,p._)("strong",null,"缓冲区",-1),i=(0,p.uE)('<p>我们要做的是反过来：从纹理中把数据复制到<strong>缓冲区</strong>，然后保存到文件中。我们得创建一个足够大的缓冲区来容纳数据：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> u32_size <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> output_buffer_size <span class="token operator">=</span> <span class="token punctuation">(</span>u32_size <span class="token operator">*</span> texture_size <span class="token operator">*</span> texture_size<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> output_buffer_desc <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferDescriptor</span> <span class="token punctuation">{</span>\n    size<span class="token punctuation">:</span> output_buffer_size<span class="token punctuation">,</span>\n    usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">COPY_DST</span>\n        <span class="token comment">// MAP_READ 告诉 wpgu 我们要在 cpu 端读取此缓冲区</span>\n        <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">MAP_READ</span><span class="token punctuation">,</span>\n    label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n    mapped_at_creation<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> output_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_buffer_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',2),k={href:"/beginner/tutorial3-pipeline/#writing-the-shaders",target:"_blank",rel:"noopener noreferrer"},r=(0,p.uE)('<div class="language-wgsl ext-wgsl line-numbers-mode"><pre class="language-wgsl"><code><span class="token comment">// 顶点着色器</span>\n\n<span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>\n    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>\n<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>\n    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">vertex_index</span><span class="token punctuation">)</span></span> in_vertex_index<span class="token punctuation">:</span> <span class="token builtin">u32</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token builtin">f32</span><span class="token punctuation">(</span><span class="token int-literal number">1</span> <span class="token operator">-</span> <span class="token builtin">i32</span><span class="token punctuation">(</span>in_vertex_index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token decimal-float-literal number">0.5</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token builtin">f32</span><span class="token punctuation">(</span><span class="token builtin">i32</span><span class="token punctuation">(</span>in_vertex_index <span class="token operator">&amp;</span> <span class="token int-literal number">1u</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token int-literal number">2</span> <span class="token operator">-</span> <span class="token int-literal number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token decimal-float-literal number">0.5</span><span class="token punctuation">;</span>\n    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> out<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 片元着色器</span>\n\n<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>\n<span class="token keyword">fn</span> <span class="token functions function">fs_main</span><span class="token punctuation">(</span>in<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.3</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.2</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.1</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后用着色器来创建一个简单的<strong>渲染管线</strong> <code>RenderPipeline</code>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code> <span class="token keyword">let</span> shader <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderModuleDescriptor</span> <span class="token punctuation">{</span>\n            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Shader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            source<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderSource</span><span class="token punctuation">::</span><span class="token class-name">Wgsl</span><span class="token punctuation">(</span><span class="token macro property">include_str!</span><span class="token punctuation">(</span><span class="token string">&quot;shader.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> render_pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>\n    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pipeline Layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>\n    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pipeline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    layout<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>render_pipeline_layout<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    vertex<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexState</span> <span class="token punctuation">{</span>\n        module<span class="token punctuation">:</span> <span class="token operator">&amp;</span>shader<span class="token punctuation">,</span>\n        entry_point<span class="token punctuation">:</span> <span class="token string">&quot;vs_main&quot;</span><span class="token punctuation">,</span>\n        buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    fragment<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FragmentState</span> <span class="token punctuation">{</span>\n        module<span class="token punctuation">:</span> <span class="token operator">&amp;</span>fs_module<span class="token punctuation">,</span>\n        entry_point<span class="token punctuation">:</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>\n        targets<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ColorTargetState</span> <span class="token punctuation">{</span>\n            format<span class="token punctuation">:</span> texture_desc<span class="token punctuation">.</span>format<span class="token punctuation">,</span>\n            alpha_blend<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BlendState</span><span class="token punctuation">::</span><span class="token constant">REPLACE</span><span class="token punctuation">,</span>\n            color_blend<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BlendState</span><span class="token punctuation">::</span><span class="token constant">REPLACE</span><span class="token punctuation">,</span>\n            write_mask<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ColorWrites</span><span class="token punctuation">::</span><span class="token constant">ALL</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    primitive<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveState</span> <span class="token punctuation">{</span>\n        topology<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">::</span><span class="token class-name">TriangleList</span><span class="token punctuation">,</span>\n        strip_index_format<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n        front_face<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FrontFace</span><span class="token punctuation">::</span><span class="token class-name">Ccw</span><span class="token punctuation">,</span>\n        cull_mode<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Face</span><span class="token punctuation">::</span><span class="token class-name">Back</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        polygon_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PolygonMode</span><span class="token punctuation">::</span><span class="token class-name">Fill</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    depth_stencil<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n    multisample<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">MultisampleState</span> <span class="token punctuation">{</span>\n        count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        mask<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span>\n        alpha_to_coverage_enabled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着创建一个<strong>命令编码器</strong> <code>CommandEncoder</code>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CommandEncoderDescriptor</span> <span class="token punctuation">{</span>\n    label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>离屏渲染最关键的地方就是<strong>渲染通道</strong> 的设置了。一个渲染通道至少需要一个<strong>颜色附件</strong>，一个颜色附件需要绑定一个<strong>纹理视图</strong>。前面的教程我们一直使用的是<strong>交换链</strong>（<code>SwapChain</code>）的纹理视图，但事实上任何纹理视图都可以，包括我们自己创建的 <code>texture_view</code>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token punctuation">{</span>\n    <span class="token keyword">let</span> render_pass_desc <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>\n        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>\n            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>\n                view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>texture_view<span class="token punctuation">,</span>\n                resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n                ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>\n                    load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>\n                        r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>\n                        g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>\n                        b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>\n                        a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>\n                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    store<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span><span class="token punctuation">,</span>\n        depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> <span class="token keyword">mut</span> render_pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>render_pass_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    render_pass<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>让我们把绘制在<strong>纹理</strong>（<code>Texture</code>）中的像素数据复制到 <code>output_buffer</code> <strong>缓冲区</strong>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code>encoder<span class="token punctuation">.</span><span class="token function">copy_texture_to_buffer</span><span class="token punctuation">(</span>\n    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ImageCopyTexture</span> <span class="token punctuation">{</span>\n        aspect<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureAspect</span><span class="token punctuation">::</span><span class="token class-name">All</span><span class="token punctuation">,</span>\n                texture<span class="token punctuation">:</span> <span class="token operator">&amp;</span>texture<span class="token punctuation">,</span>\n        mip_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n        origin<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Origin3d</span><span class="token punctuation">::</span><span class="token constant">ZERO</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ImageCopyBuffer</span> <span class="token punctuation">{</span>\n        buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span>output_buffer<span class="token punctuation">,</span>\n        layout<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ImageDataLayout</span> <span class="token punctuation">{</span>\n            offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            bytes_per_row<span class="token punctuation">:</span> u32_size <span class="token operator">*</span> texture_size<span class="token punctuation">,</span>\n            rows_per_image<span class="token punctuation">:</span> texture_size<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    texture_desc<span class="token punctuation">.</span>size<span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面已经<strong>编码</strong>（Encode）好了所有的<strong>命令</strong>（Command），现在把它们提交给 GPU 来执行：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code>queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="从缓冲区中读取数据" tabindex="-1"><a class="header-anchor" href="#从缓冲区中读取数据" aria-hidden="true">#</a> 从缓冲区中读取数据</h2><p>为了从<strong>缓冲区</strong>中读取数据，首先需要对它进行<strong>映射</strong>（Map），然后执行 <code>get_mapped_range()</code> 就可以得到一个<strong>缓冲区视图</strong> （<code>BufferView</code>）实例，它实质上就是一个 <code>&amp;[u8]</code> 类型数据的容器：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 需要对映射变量设置范围，以便我们能够解除缓冲区的映射</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">let</span> buffer_slice <span class="token operator">=</span> output_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 注意：我们必须在 await future 之前先创建映射，然后再调用 device.poll()。</span>\n    <span class="token comment">// 否则，应用程序将停止响应。</span>\n    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">futures_intrusive<span class="token punctuation">::</span>channel<span class="token punctuation">::</span>shared<span class="token punctuation">::</span></span><span class="token function">oneshot_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    buffer_slice<span class="token punctuation">.</span><span class="token function">map_async</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">MapMode</span><span class="token punctuation">::</span><span class="token class-name">Read</span><span class="token punctuation">,</span> <span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>result<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>\n        tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    device<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Maintain</span><span class="token punctuation">::</span><span class="token class-name">Wait</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    rx<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">let</span> data <span class="token operator">=</span> buffer_slice<span class="token punctuation">.</span><span class="token function">get_mapped_range</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">use</span> <span class="token namespace">image<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">ImageBuffer</span><span class="token punctuation">,</span> <span class="token class-name">Rgba</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> buffer <span class="token operator">=</span>\n        <span class="token class-name">ImageBuffer</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Rgba</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> _<span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>texture_size<span class="token punctuation">,</span> texture_size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    buffer<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">&quot;image.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">}</span>\n<span class="token comment">// 解除缓冲区映射</span>\noutput_buffer<span class="token punctuation">.</span><span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',14),d={class:"note"},m={href:"https://docs.rs/futures-intrusive",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/gfx-rs/wgpu/tree/master/wgpu/examples/capture",target:"_blank",rel:"noopener noreferrer"},A=(0,p._)("strong",null,"包",-1),b=(0,p._)("h2",{id:"main-函数不能异步化",tabindex:"-1"},[(0,p._)("a",{class:"header-anchor",href:"#main-函数不能异步化","aria-hidden":"true"},"#"),(0,p.Uk)(" Main 函数不能异步化")],-1),g=(0,p._)("code",null,"main()",-1),f=(0,p._)("strong",null,"Future",-1),w=(0,p._)("code",null,"async",-1),_=(0,p._)("code",null,"main()",-1),C=(0,p._)("strong",null,"阻塞",-1),h=(0,p._)("strong",null,"Future",-1),B=(0,p._)("strong",null,"包",-1),E={href:"https://docs.rs/pollster",target:"_blank",rel:"noopener noreferrer"},x={class:"note"},y=(0,p._)("strong",null,"包",-1),Q=(0,p._)("code",null,"main()",-1),I={href:"https://docs.rs/async-std",target:"_blank",rel:"noopener noreferrer"},M={href:"https://docs.rs/tokio",target:"_blank",rel:"noopener noreferrer"},U=(0,p.uE)('<div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 离屏绘制代码...</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token namespace">pollster<span class="token punctuation">::</span></span><span class="token function">block_on</span><span class="token punctuation">(</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在运行代码，就会在项目根目录输出这样一张名为 <code>image.png</code> 的图像：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAFq0lEQVR4nO3U2XVcRxBEQcovOiJf5IY8kl8SRLAPAXAweEvvGfFRFlTeP/786+9/vwGRBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEINj3b/+83G8v9/vLJZEABBMABCBUGX8hApkEIJQA8D8BCPRx/IUI5BGAQAJAIQBhPht/IQJZBCCMAPCWAAT5avyFCOQQgCACwEcCEOLo+AsRyCAAIQSARwQgwNnxFyKwPwEIIAB8RgA2d3X8hQjsTQA2JwA8IwAbuzv+QgT2JQAbEwC+IgCbqjX+QgT2JACbEgCOEIAN1R5/IQL7EYANCQBHCcBmWo2/EIG9CMBmBIAzBGAjrcdfiMA+BGAjAsBZArCJXuMvRGAPArAJAeAKAdhA7/EXIrA+AdiAAHCVACxu1PgLEVibACxOALhDABY2evyFCKxLABYmANwlAIuaZfyFCKxJABYlANQgAAuabfyFCKxHABYkANQiAIuZdfyFCKxFABYjANQkAAuZffyFCKxDABYiANQmAItYZfyFCKxBABYhALQgAAtYbfyFCMxPABYgALQiAJNbdfyFCMxNACYnALQkABNbffyFCMxLACYmALQmAJPaZfyFCMxJACYlAPQgABPabfyFCMxHACYkAPQiAJPZdfyFCMxFACYjAPQkABPZffyFCMxDACYiAPQmAJNIGX8hAnMQgEkIACMIwATSxl+IwHgCMAEBYBQBGCx1/IUIjCUAgwmAAIwkAAOlj78QgXEEYCABeCUA4wjAIMb/ngiMIQCDCMB7AjCGAAxg/I+JQH8CMIAAPCYA/QlAZ8b/nAj0JQCdCcBzAtCXAHRk/MeIQD8C0JEAHCMA/QhAJ8Z/jgj0IQCdCMA5AtCHAHRg/NeIQHsC0IEAXCMA7QlAY8Z/jwi0JQCNCcA9AtCWADRk/HWIQDsC0JAA1CEA7QhAI8Zflwi0IQCNCEBdAtCGADRg/G2IQH0C0IAAtCEA9QlAZcbflgjUJQCVCUBbAlCXAFRk/H2IQD0CUJEA9CEA9QhAJcbflwjUIQCVCEBfAlCHAFRg/GOIwH0CUIEAjCEA9wnATcY/lgjcIwA3CcBYAnCPANxg/HMQgesE4AYBmIMAXCcAFxn/XETgGgG4SADmIgDXCMAFxj8nEThPAC4QgDkJwHkCcJLxz00EzhGAkwRgbgJwjgCcYPxrEIHjBOAEAViDABwnAAcZ/1pE4BgBOEgA1iIAxwjAAca/JhH4mgAcIABrEoCvCcAXjH9tIvCcAHxBANYmAM8JwBPGvwcR+JwAPCEAexCAzwnAJ4x/LyLwmAB8QgD2IgCPCcADxr8nEfidADwgAHsSgN8JwAfGvzcReE8APhCAvQnAewLwhvFnEIFfBOANAcggAL8IwE/Gn0UEXgnATwKQRQBeCcAL488kAgLwgwBkEgABeHkB40+WHoH4AEAyAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAINh/p/JoLhfYRNsAAAAASUVORK5CYII=" alt="a brown triangle"></p>',3),R={},Y=(0,a(3744).Z)(R,[["render",function(n,s){const a=(0,p.up)("ExternalLinkIcon"),R=(0,p.up)("AutoGithubLink");return(0,p.wg)(),(0,p.iD)("div",null,[t,(0,p._)("p",null,[(0,p.Uk)("虽然我们已经说过不需要看到 gpu 在做什么，但确实需要在某些时候看到结果。如果回顾一下关于 "),(0,p._)("a",e,[(0,p.Uk)("surface"),(0,p.Wm)(a)]),(0,p.Uk)(" 的讨论，会发现我们是使用 "),c,(0,p.Uk)(" 获取一个纹理来绘制。")]),o,(0,p._)("p",null,[(0,p.Uk)("虽然我们可以使用这个纹理来绘制三角形，但还需要一些方法来获取它里面的像素。在"),(0,p._)("a",l,[(0,p.Uk)("纹理"),(0,p.Wm)(a)]),(0,p.Uk)("教程中，我们用一个"),u,(0,p.Uk)("从一个文件中加载颜色数据，然后复制到另一个缓冲区。")]),i,(0,p._)("p",null,[(0,p.Uk)("现在已经做好了离屏绘制的准备，让我们来绘制点东西试试。由于只是画一个三角形，可以重用"),(0,p._)("a",k,[(0,p.Uk)("管线"),(0,p.Wm)(a)]),(0,p.Uk)("教程中的着色器代码:")]),r,(0,p._)("div",d,[(0,p._)("p",null,[(0,p.Uk)("这个程序使用了 "),(0,p._)("a",m,[(0,p.Uk)("futures-intrusive"),(0,p.Wm)(a)]),(0,p.Uk)("，那也是 "),(0,p._)("a",v,[(0,p.Uk)("wgpu 的 demo"),(0,p.Wm)(a)]),(0,p.Uk)(" 中使用的"),A,(0,p.Uk)("。")])]),b,(0,p._)("p",null,[g,(0,p.Uk)(" 做为程序的入口函数，它默认无法返回一个 "),f,(0,p.Uk)("（异步任务抽象单元），所以不能使用 "),w,(0,p.Uk)(" 关键字。我们将通过把代码封装到另一个函数中来解决此问题，这样就可以在 "),_,(0,p.Uk)(" 中"),C,(0,p.Uk)("它（也就是等待函数真正执行完成）。异步函数被调用时会立即返回一个 "),h,(0,p.Uk)(" 对象，此时函数内的任务可能还没有真正开始执行， 我们需要使用一个可以轮询 Future 的"),B,(0,p.Uk)("，比如"),(0,p._)("a",E,[(0,p.Uk)("pollster crate"),(0,p.Wm)(a)]),(0,p.Uk)("。")]),(0,p._)("div",x,[(0,p._)("p",null,[(0,p.Uk)("有一些"),y,(0,p.Uk)("可以用来标注 "),Q,(0,p.Uk)(" 函数为异步，如 "),(0,p._)("a",I,[(0,p.Uk)("async-std"),(0,p.Wm)(a)]),(0,p.Uk)(" 和 "),(0,p._)("a",M,[(0,p.Uk)("tokio"),(0,p.Wm)(a)]),(0,p.Uk)("。我选择不这样做，因为这两个包对咱们的项目来说都有点儿重了。当然，你可以使用你喜欢的任何异步包和设置。")])]),U,(0,p.Wm)(R)])}]])}}]);