"use strict";(self.webpackChunklearn_wgpu_zh=self.webpackChunklearn_wgpu_zh||[]).push([[7916],{6472:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e=JSON.parse('{"key":"v-1d87647f","path":"/beginner/tutorial2-surface/","title":"展示平面 (Surface)","lang":"zh-CN","frontmatter":{},"excerpt":"","headers":[{"level":2,"title":"封装 State","slug":"封装-state","link":"#封装-state","children":[]},{"level":2,"title":"实例化 State","slug":"实例化-state","link":"#实例化-state","children":[{"level":3,"title":"GPU 实例与适配器","slug":"gpu-实例与适配器","link":"#gpu-实例与适配器","children":[]},{"level":3,"title":"展示平面","slug":"展示平面","link":"#展示平面","children":[]},{"level":3,"title":"逻辑设备与命令队列","slug":"逻辑设备与命令队列","link":"#逻辑设备与命令队列","children":[]}]},{"level":2,"title":"调整展示平面的宽高","slug":"调整展示平面的宽高","link":"#调整展示平面的宽高","children":[]},{"level":2,"title":"事件输入","slug":"事件输入","link":"#事件输入","children":[]},{"level":2,"title":"更新","slug":"更新","link":"#更新","children":[]},{"level":2,"title":"渲染","slug":"渲染","link":"#渲染","children":[]},{"level":2,"title":"关于 RenderPassDescriptor","slug":"关于-renderpassdescriptor","link":"#关于-renderpassdescriptor","children":[]},{"level":2,"title":"验证错误?","slug":"验证错误","link":"#验证错误","children":[]},{"level":2,"title":"挑战","slug":"挑战","link":"#挑战","children":[]}],"git":{"updatedTime":1663412803000},"filePathRelative":"beginner/tutorial2-surface/README.md"}')},873:(n,s,a)=>{a.r(s),a.d(s,{default:()=>Xn});var e=a(6252);const t=a.p+"assets/img/no-clear.394368fb.png",p=(0,e.uE)('<h1 id="展示平面-surface" tabindex="-1"><a class="header-anchor" href="#展示平面-surface" aria-hidden="true">#</a> 展示平面 (Surface)</h1><h2 id="封装-state" tabindex="-1"><a class="header-anchor" href="#封装-state" aria-hidden="true">#</a> 封装 State</h2><p>为方便起见，我们将所有<strong>字段</strong>封装在一个<strong>结构体</strong>内，并在其上添加一些函数：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// lib.rs</span>\n<span class="token keyword">use</span> <span class="token namespace">winit<span class="token punctuation">::</span>window<span class="token punctuation">::</span></span><span class="token class-name">Window</span><span class="token punctuation">;</span>\n\n<span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>\n    surface<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Surface</span><span class="token punctuation">,</span>\n    device<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>\n    queue<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>\n    config<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span><span class="token punctuation">,</span>\n    size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 创建某些 wgpu 类型需要使用异步代码</span>\n    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>\n        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> new_size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">fn</span> <span class="token function-definition function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">WindowEvent</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>\n        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">fn</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">fn</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此处省略了 <code>State</code> 的字段概述，在后续章节中解释这些函数背后的代码时，它们才会变得更有意义。</p><h2 id="实例化-state" tabindex="-1"><a class="header-anchor" href="#实例化-state" aria-hidden="true">#</a> 实例化 State</h2><p>这段代码很简单，但还是值得好好讲讲：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> size <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">inner_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// instance 变量是 GPU 实例</span>\n        <span class="token comment">// Backends::all 对应 Vulkan、Metal、DX12、WebGL 等所有后端图形驱动</span>\n        <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Instance</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Backends</span><span class="token punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">let</span> surface <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> instance<span class="token punctuation">.</span><span class="token function">create_surface</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token keyword">let</span> adapter <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">request_adapter</span><span class="token punctuation">(</span>\n            <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RequestAdapterOptions</span> <span class="token punctuation">{</span>\n                power_preference<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PowerPreference</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                compatible_surface<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>surface<span class="token punctuation">)</span><span class="token punctuation">,</span>\n                force_fallback_adapter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gpu-实例与适配器" tabindex="-1"><a class="header-anchor" href="#gpu-实例与适配器" aria-hidden="true">#</a> GPU 实例与适配器</h3><p><strong>GPU 实例</strong>（Instance）是使用 wgpu 时所需创建的第一个对象，其主要用途是创建<strong>适配器</strong>（Adapter）和<strong>展示平面</strong>（Surface）。</p><p><strong>适配器</strong>（Adapter）是指向 WebGPU API 实现的实例，一个系统上往往存在多个 WebGPU API 实现实例。也就是说，<strong>适配器</strong>是固定在特定图形后端的。假如你使用的是 Windows 且有 2 个显卡（集成显卡 + 独立显卡），则至少有 4 个<strong>适配器</strong>可供使用，分别有 2 个固定在 Vulkan 和 DirectX 后端。我们可以用它获取关联显卡的信息，例如显卡名称与其所适配到的后端图形驱动等。稍后我们会用它来创建<strong>逻辑设备</strong>和<strong>命令队列</strong>。现在先讨论一下 <code>RequestAdapterOptions</code> 所涉及的字段。</p>',11),o=(0,e.uE)("<li><code>power_preference</code> 枚举有两个可选项：<code>LowPower</code> 和 <code>HighPerformance</code>。 <code>LowPower</code> 对应偏向于高电池续航的适配器（如集成显卡上的 WebGPU 实现实例），<code>HighPerformance</code> 对应高功耗高性能的适配器（如独立显卡上的WebGPU 实现实例）。一旦不存在符合 <code>HighPerformance</code> 选项的适配器，wgpu 就会选择 <code>LowPower</code>。</li><li><code>compatible_surface</code> 字段告诉 wgpu 找到与所传入的<strong>展示平面</strong>兼容的适配器。</li>",2),c=(0,e._)("code",null,"force_fallback_adapter",-1),l=(0,e.Uk)(" 强制 wgpu 选择一个能在所有系统上工作的适配器，这通常意味着渲染后端将使用一个"),u=(0,e._)("strong",null,"软渲染",-1),i=(0,e.Uk)("系统，而非 GPU 这样的硬件。需要注意的是：WebGPU 标准并没有要求所有系统上都必须实现 "),A={href:"https://gpuweb.github.io/gpuweb/#fallback-adapter",target:"_blank",rel:"noopener noreferrer"},r=(0,e.Uk)("fallback adapter"),d=(0,e.Uk)(" 。"),k={class:"note"},v=(0,e.uE)('<p>此处传递给 <code>request_adapter</code> 的参数不能保证对所有设备都有效，但是应该对大多数设备都有效。当 wgpu 找不到符合要求的适配器，<code>request_adapter</code> 将返回 <code>None</code>。如果你想获取某个特定图形后端的所有<strong>适配器</strong>，可以使用 <code>enumerate_adapters</code> 函数，它会返回一个迭代器，你可以遍历检查其中是否有满足需求的适配器。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> adapter <span class="token operator">=</span> instance\n    <span class="token punctuation">.</span><span class="token function">enumerate_adapters</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Backends</span><span class="token punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>adapter<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>\n        <span class="token comment">// 检查该适配器是否兼容我们的展示平面</span>\n        surface<span class="token punctuation">.</span><span class="token function">get_preferred_format</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adapter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',2),m=(0,e.Uk)("更多可用于优化"),g=(0,e._)("strong",null,"适配器",-1),b=(0,e.Uk)("搜索的函数，请"),f={href:"https://docs.rs/wgpu/latest/wgpu/struct.Adapter.html",target:"_blank",rel:"noopener noreferrer"},E=(0,e.Uk)("查看文档"),w=(0,e.Uk)("。"),h=(0,e._)("h3",{id:"展示平面",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#展示平面","aria-hidden":"true"},"#"),(0,e.Uk)(" 展示平面")],-1),Q=(0,e._)("strong",null,"展示平面",-1),C=(0,e.Uk)("（Surface）是我们绘制到窗口的部分，需要它来将绘制结果展示（或者说，呈现）到屏幕上。窗口程序需要实现 "),I={href:"https://crates.io/crates/raw-window-handle",target:"_blank",rel:"noopener noreferrer"},y=(0,e.Uk)("raw-window-handle"),B=(0,e.Uk)(),U=(0,e._)("strong",null,"包",-1),_=(0,e.Uk)("的 "),q=(0,e._)("code",null,"HasRawWindowHandle",-1),R=(0,e.Uk)(" trait 来创建展示平面。所幸 winit 的 "),O=(0,e._)("code",null,"Window",-1),z=(0,e.Uk)(" 符合这个要求。我们还需要展示平面来请求"),D=(0,e._)("strong",null,"适配器",-1),P=(0,e.Uk)("。"),T=(0,e.uE)('<h3 id="逻辑设备与命令队列" tabindex="-1"><a class="header-anchor" href="#逻辑设备与命令队列" aria-hidden="true">#</a> 逻辑设备与命令队列</h3><p>让我们使用<strong>适配器</strong>来创建<strong>逻辑设备</strong> (Device) 和<strong>命令队列</strong> (Queue)。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code>    <span class="token keyword">let</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">)</span> <span class="token operator">=</span> adapter<span class="token punctuation">.</span><span class="token function">request_device</span><span class="token punctuation">(</span>\n        <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DeviceDescriptor</span> <span class="token punctuation">{</span>\n            features<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Features</span><span class="token punctuation">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token comment">// WebGL 后端并不支持 wgpu 的所有功能，</span>\n            <span class="token comment">// 所以如果要以 web 为构建目标，就必须禁用一些功能。</span>\n            limits<span class="token punctuation">:</span> <span class="token keyword">if</span> <span class="token macro property">cfg!</span><span class="token punctuation">(</span>target_arch <span class="token operator">=</span> <span class="token string">&quot;wasm32&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Limits</span><span class="token punctuation">::</span><span class="token function">downlevel_webgl2_defaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Limits</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token comment">// 追踪 API 调用路径</span>\n    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>DeviceDescriptor</code>上的 <code>features</code> 字段允许我们指定想要的扩展功能。对于这个简单的例子，我决定不使用任何额外的功能。</p>',4),J={class:"note"},x=(0,e._)("p",null,"显卡会限制可用的扩展功能，所以如果想使用某些功能，你可能需要限制支持的设备或提供变通函数。",-1),N=(0,e._)("p",null,[(0,e.Uk)("可以使用 "),(0,e._)("code",null,"adapter.features()"),(0,e.Uk)(" 或 "),(0,e._)("code",null,"device.features()"),(0,e.Uk)(" 获取设备支持的扩展功能列表。")],-1),W=(0,e.Uk)("如果有需要，请查看完整的"),M={href:"https://docs.rs/wgpu/latest/wgpu/struct.Features.html",target:"_blank",rel:"noopener noreferrer"},H=(0,e.Uk)("扩展功能列表"),K=(0,e.Uk)("。"),S=(0,e._)("code",null,"limits",-1),Z=(0,e.Uk)(" 字段描述了创建某些类型的资源的限制。我们在本教程中使用默认值，所以可以支持大多数设备。你可以"),F={href:"https://docs.rs/wgpu/0.13.1/wgpu/struct.Limits.html",target:"_blank",rel:"noopener noreferrer"},V=(0,e.Uk)("在这里"),L=(0,e.Uk)("查看限制列表。"),G=(0,e.uE)('<div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code>    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span> <span class="token punctuation">{</span>\n        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>\n        format<span class="token punctuation">:</span> surface<span class="token punctuation">.</span><span class="token function">get_supported_formats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adapter<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        width<span class="token punctuation">:</span> size<span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n        height<span class="token punctuation">:</span> size<span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n        present_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PresentMode</span><span class="token punctuation">::</span><span class="token class-name">Fifo</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    surface<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们为<strong>展示平面</strong>定义了一个配置。它将定义展示平面如何创建其底层的 <code>SurfaceTexture</code>。讲 <code>render</code> 函数时我们再具体讨论 <code>SurfaceTexture</code>，现在先谈谈此配置的字段。</p><p><code>usage</code> 字段描述了 <code>SurfaceTexture</code> 如何被使用。<code>RENDER_ATTACHMENT</code> 指定将被用来渲染到屏幕的纹理（我们将在后面讨论更多的 <code>TextureUsages</code> 枚举值）。</p><p><code>format</code> 定义了 <code>SurfaceTexture</code> 在 GPU 内存上如何被存储。不同的显示设备偏好不同的纹理格式。我们使用<code>surface.get_preferred_format(&amp;adapter)</code> 来获取你使用的显示设备的最佳格式。</p><p><code>width</code> 和 <code>height</code> 指定 <code>SurfaceTexture</code> 的宽度和高度（物理像素，等于逻辑像素乘以屏幕缩放因子）。这通常就是窗口的宽和高。</p><div class="warning"><p>需要确保 <code>SurfaceTexture</code> 的宽高不能为 0，这会导致你的应用程序崩溃。</p></div>',6),j=(0,e.uE)("<code>present_mode</code> 指定的 <code>wgpu::PresentMode</code> 枚举值决定了<strong>展示平面</strong>如何与<strong>显示设备</strong>同步。我们选择的<code>PresentMode::Fifo</code> 指定了显示设备的刷新率做为渲染的帧速率，这本质上就是<strong>垂直同步</strong>（VSync），所有平台都得支持这种<strong>呈现模式</strong>（PresentMode）。你可以在",14),X={href:"https://docs.rs/wgpu/latest/wgpu/enum.PresentMode.html",target:"_blank",rel:"noopener noreferrer"},Y=(0,e.Uk)("文档"),$=(0,e.Uk)("中查看所有的模式。"),nn={class:"note"},sn=(0,e.Uk)("当你想让用户来选择他们使用的"),an=(0,e._)("strong",null,"呈现模式",-1),en=(0,e.Uk)("时，可以使用 "),tn={href:"https://docs.rs/wgpu/latest/wgpu/struct.Surface.html#method.get_supported_modes",target:"_blank",rel:"noopener noreferrer"},pn=(0,e.Uk)("Surface::get_supported_modes()"),on=(0,e.Uk)(" 获取展示平面支持的所有"),cn=(0,e._)("strong",null,"呈现模式",-1),ln=(0,e.Uk)("的列表:"),un=(0,e.uE)('<div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> modes <span class="token operator">=</span> surface<span class="token punctuation">.</span><span class="token function">get_supported_modes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>PresentMode::Fifo</code> 模式无论如何都是被支持的，<code>PresentMode::AutoVsync</code> 和 <code>PresentMode::AutoNoVsync</code> 支持回退，因此也能工作在所有平台上。</p>',2),An=(0,e.uE)('<p>现在已经正确地配置了<strong>展示平面</strong>，我们在函数的末尾添加上这些新字段：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code>        <span class="token keyword">Self</span> <span class="token punctuation">{</span>\n            surface<span class="token punctuation">,</span>\n            device<span class="token punctuation">,</span>\n            queue<span class="token punctuation">,</span>\n            config<span class="token punctuation">,</span>\n            size<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 <code>State::new()</code> 函数是异步的，因此需要把 <code>run()</code> 也改成异步的，以便可以在函数调用处等待它。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 窗口设置...</span>\n\n    <span class="token keyword">let</span> <span class="token keyword">mut</span> state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 事件遍历...</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',4),rn=(0,e.Uk)("现在 "),dn=(0,e._)("code",null,"run()",-1),kn=(0,e.Uk)(" 是异步的了，"),vn=(0,e._)("code",null,"main()",-1),mn=(0,e.Uk)(" 需要某种方式来等待它执行完成。我们可以使用 "),gn={href:"https://docs.rs/tokio",target:"_blank",rel:"noopener noreferrer"},bn=(0,e.Uk)("tokio"),fn=(0,e.Uk)(" 或 "),En={href:"https://docs.rs/async-std",target:"_blank",rel:"noopener noreferrer"},wn=(0,e.Uk)("async-std"),hn=(0,e.Uk)(" 等异步"),Qn=(0,e._)("strong",null,"包",-1),Cn=(0,e.Uk)("，但我打算使用更轻量级的 "),In={href:"https://docs.rs/pollster",target:"_blank",rel:"noopener noreferrer"},yn=(0,e.Uk)("pollster"),Bn=(0,e.Uk)('。在 "Cargo.toml" 中添加以下依赖：'),Un=(0,e.uE)('<div class="language-toml ext-toml line-numbers-mode"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>\n<span class="token comment"># 其他依赖...</span>\n<span class="token key property">pollster</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后我们使用 pollster 提供的 <code>block_on</code> 函数来等待异步任务执行完成：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token namespace">pollster<span class="token punctuation">::</span></span><span class="token function">block_on</span><span class="token punctuation">(</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="warning"><p>WASM 环境中不能在异步函数里使用 <code>block_on</code>。<code>Future</code>（异步函数的返回对象）必须使用浏览器的执行器来运行。如果你试图使用自己的执行器，一旦遇到没有立即执行的 <code>Future</code> 时代码就会崩溃。</p></div>',4),_n=(0,e.Uk)("如果现在尝试构建 WASM 将会失败，因为 "),qn=(0,e._)("code",null,"wasm-bindgen",-1),Rn=(0,e.Uk)(" 不支持使用异步函数作为“开始”函数。你可以改成在 javascript 中手动调用 "),On=(0,e._)("code",null,"run",-1),zn=(0,e.Uk)("，但为了简单起见，我们将把 "),Dn={href:"https://docs.rs/wasm-bindgen-futures",target:"_blank",rel:"noopener noreferrer"},Pn=(0,e.Uk)("wasm-bindgen-futures"),Tn=(0,e.Uk)(),Jn=(0,e._)("strong",null,"包",-1),xn=(0,e.Uk)("添加到 WASM 依赖项中，因为这不需要改变任何代码。你的依赖项应该是这样的："),Nn=(0,e.uE)('<div class="language-toml ext-toml line-numbers-mode"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>\n<span class="token key property">cfg-if</span> <span class="token punctuation">=</span> <span class="token string">&quot;1&quot;</span>\n<span class="token key property">winit</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.26&quot;</span>\n<span class="token key property">env_logger</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.9&quot;</span>\n<span class="token key property">log</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.4&quot;</span>\n<span class="token key property">wgpu</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.13&quot;</span>\n<span class="token key property">pollster</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">target.&#39;cfg(target_arch = &quot;wasm32&quot;)&#39;.dependencies</span><span class="token punctuation">]</span>\n<span class="token key property">console_error_panic_hook</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.1.6&quot;</span>\n<span class="token key property">console_log</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2.0&quot;</span>\n<span class="token key property">wgpu</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.13&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\n<span class="token key property">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>\n<span class="token key property">wasm-bindgen-futures</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.4&quot;</span>\n<span class="token key property">web-sys</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.3&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>\n    <span class="token string">&quot;Document&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;Window&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;Element&quot;</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span><span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="调整展示平面的宽高" tabindex="-1"><a class="header-anchor" href="#调整展示平面的宽高" aria-hidden="true">#</a> 调整展示平面的宽高</h2><p>如果要在应用程序中支持调整<strong>展示平面</strong>的宽高，将需要在每次窗口的大小改变时重新配置 <code>surface</code>。这就是我们存储物理 <code>size</code> 和用于配置 <code>surface</code> 的 <code>config</code> 的原因。有了这些，实现 resize 函数就非常简单了。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// impl State</span>\n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> new_size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> new_size<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> new_size<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>\n        <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token operator">=</span> new_size<span class="token punctuation">;</span>\n        <span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>width <span class="token operator">=</span> new_size<span class="token punctuation">.</span>width<span class="token punctuation">;</span>\n        <span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>height <span class="token operator">=</span> new_size<span class="token punctuation">.</span>height<span class="token punctuation">;</span>\n        <span class="token keyword">self</span><span class="token punctuation">.</span>surface<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里和最初的 <code>surface</code> 配置没什么不同，所以就不再赘述。</p><p>在 <code>run()</code> 函数的事件循环中，我们在以下事件中调用 <code>resize()</code> 函数。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">match</span> event <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n\n    <span class="token punctuation">}</span> <span class="token keyword">if</span> window_id <span class="token operator">==</span> window<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">match</span> event <span class="token punctuation">{</span>\n            <span class="token comment">// ...</span>\n\n            <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">Resized</span><span class="token punctuation">(</span>physical_size<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span>physical_size<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">ScaleFactorChanged</span> <span class="token punctuation">{</span> new_inner_size<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                <span class="token comment">// new_inner_size 是 &amp;&amp;mut 类型，因此需要解引用两次</span>\n                state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>new_inner_size<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="事件输入" tabindex="-1"><a class="header-anchor" href="#事件输入" aria-hidden="true">#</a> 事件输入</h2><p><code>input()</code> 函数返回一个 <code>bool</code>（布尔值），表示一个事件是否已经被处理。如果该函数返回 <code>true</code>，主循环就不再继续处理该事件。</p><p>我们现在没有任何想要捕获的事件，只需要返回 false。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// impl State</span>\n<span class="token keyword">fn</span> <span class="token function-definition function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">WindowEvent</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>\n    <span class="token boolean">false</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还需要在事件循环中多做一点工作，我们希望 <code>State</code> 在 <code>run()</code> 函数内的事件处理中拥有第一优先级。修改后（加上之前的修改）的代码看起来像是这样的：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// run()</span>\nevent_loop<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>event<span class="token punctuation">,</span> _<span class="token punctuation">,</span> control_flow<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>\n    <span class="token keyword">match</span> event <span class="token punctuation">{</span>\n        <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">WindowEvent</span> <span class="token punctuation">{</span>\n            <span class="token keyword">ref</span> event<span class="token punctuation">,</span>\n            window_id<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span> <span class="token keyword">if</span> window_id <span class="token operator">==</span> window<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 更新!</span>\n            <span class="token keyword">match</span> event <span class="token punctuation">{</span>\n                <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">CloseRequested</span>\n                <span class="token operator">|</span> <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">KeyboardInput</span> <span class="token punctuation">{</span>\n                    input<span class="token punctuation">:</span>\n                        <span class="token class-name">KeyboardInput</span> <span class="token punctuation">{</span>\n                            state<span class="token punctuation">:</span> <span class="token class-name">ElementState</span><span class="token punctuation">::</span><span class="token class-name">Pressed</span><span class="token punctuation">,</span>\n                            virtual_keycode<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">Escape</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                            <span class="token punctuation">..</span>\n                        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                    <span class="token punctuation">..</span>\n                <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token operator">*</span>control_flow <span class="token operator">=</span> <span class="token class-name">ControlFlow</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">,</span>\n                <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">Resized</span><span class="token punctuation">(</span>physical_size<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                    state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span>physical_size<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n                <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">ScaleFactorChanged</span> <span class="token punctuation">{</span> new_inner_size<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                    state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>new_inner_size<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n                _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="更新" tabindex="-1"><a class="header-anchor" href="#更新" aria-hidden="true">#</a> 更新</h2><p>目前还没有任何东西需要更新，所以令这个函数为空。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// remove `todo!()`</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们稍后将在这里添加一些代码，以便让绘制对象动起来。</p><h2 id="渲染" tabindex="-1"><a class="header-anchor" href="#渲染" aria-hidden="true">#</a> 渲染</h2><p>这里就是奇迹发生的地方。首先，我们需要获取一个<strong>帧</strong>（Frame）对象以供渲染：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// impl State</span>\n\n<span class="token keyword">fn</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>surface<span class="token punctuation">.</span><span class="token function">get_current_texture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>get_current_texture</code> 函数会等待 <code>surface</code> 提供一个新的 <code>SurfaceTexture</code>。我们将它存储在 <code>output</code> 变量中以便后续使用。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> view <span class="token operator">=</span> output<span class="token punctuation">.</span>texture<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这一行创建了一个默认设置的<strong>纹理视图</strong>（TextureView），渲染代码需要利用<strong>纹理视图</strong>来与<strong>纹理</strong>交互。</p><p>我们还需要创建一个<strong>命令编码器</strong>（CommandEncoder）来记录实际的<strong>命令</strong>发送给 GPU。大多数现代图形框架希望命令在被发送到 GPU 之前存储在一个<strong>命令缓冲区</strong>中。命令编码器创建了一个命令缓冲区，然后我们可以将其发送给 GPU。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CommandEncoderDescriptor</span> <span class="token punctuation">{</span>\n    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Encoder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在可以开始执行期盼已久的<strong>清屏</strong>（用统一的颜色填充指定渲染区域）了。我们需要使用 <code>encoder</code> 来创建 <code>RenderPass</code>。<code>RenderPass</code> 拥有所有实际绘制的<strong>命令</strong>。创建 <code>RenderPass</code> 的代码嵌套层级有点深，所以在谈论它之前，我先把代码全部复制到这里：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code>    <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> _render_pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>\n            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>\n                view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>view<span class="token punctuation">,</span>\n                resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n                ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>\n                    load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>\n                        r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>\n                        g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>\n                        b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>\n                        a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>\n                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    store<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// submit 命令能接受任何实现了 IntoIter trait 的参数</span>\n    <span class="token keyword">self</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token function">once</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    output<span class="token punctuation">.</span><span class="token function">present</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先，我们来谈谈 <code>encoder.begin_render_pass(...)</code> 周围用 <code>{}</code> 开辟出来的块空间。<code>begin_render_pass()</code> 以可变方式借用了<code>encoder</code>（又称 <code>&amp;mut self</code>），在释放这个可变借用之前，我们不能调用 <code>encoder.finish()</code>。这个块空间告诉 rust，当代码离开这个范围时，丢弃其中的任何变量，从而释放 <code>encoder</code> 上的可变借用，并允许我们 <code>finish()</code> 它。如果你不喜欢 <code>{}</code>，也可以使用 <code>drop(render_pass)</code> 来达到同样的效果。</p><p>代码的最后几行告诉 <code>wgpu</code> 完成<strong>命令缓冲区</strong>，并将其提交给 gpu 的<strong>渲染队列</strong>。</p><p>我们需再次更新事件循环以调用 <code>render()</code> 函数，还会在它之前先调用 <code>update()</code>。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// run()</span>\nevent_loop<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>event<span class="token punctuation">,</span> _<span class="token punctuation">,</span> control_flow<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>\n    <span class="token keyword">match</span> event <span class="token punctuation">{</span>\n        <span class="token comment">// ...</span>\n        <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">RedrawRequested</span><span class="token punctuation">(</span>window_id<span class="token punctuation">)</span> <span class="token keyword">if</span> window_id <span class="token operator">==</span> window<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n            state<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">match</span> state<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n                <span class="token comment">// 当展示平面的上下文丢失，就需重新配置</span>\n                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token punctuation">::</span><span class="token class-name">Lost</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span>\n                <span class="token comment">// 系统内存不足时，程序应该退出。</span>\n                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token punctuation">::</span><span class="token class-name">OutOfMemory</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">*</span>control_flow <span class="token operator">=</span> <span class="token class-name">ControlFlow</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">,</span>\n                <span class="token comment">// 所有其他错误（过期、超时等）应在下一帧解决</span>\n                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">MainEventsCleared</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 除非我们手动请求，RedrawRequested 将只会触发一次。</span>\n            window<span class="token punctuation">.</span><span class="token function">request_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// ...</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基于以上这些，你就能获得如下渲染效果：</p><p><img src="data:image/png;base64,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IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAuqkk2b5udKHnAAAAfob8P4Fe1tYvSjndAAAAAElFTkSuQmCC" alt="蓝色背景的窗口"></p><h2 id="关于-renderpassdescriptor" tabindex="-1"><a class="header-anchor" href="#关于-renderpassdescriptor" aria-hidden="true">#</a> 关于 RenderPassDescriptor</h2><p>部分读者可能光看代码就能理解，但如果我不把它介绍一遍，那就是失职。让我们再看一下代码：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>\n    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>\n        <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>RenderPassDescriptor</code> 只有三个字段: <code>label</code>, <code>color_attachments</code> 和 <code>depth_stencil_attachment</code>。<code>color_attachments</code> 描述了要将颜色绘制到哪里。我们使用之前创建的<strong>纹理视图</strong>来确保渲染到屏幕上。</p><div class="note"><p><code>color_attachments</code> 字段是一个稀疏数组。这允许你使用有多个渲染目标的<strong>管线</strong>，并且最终只绘制到你所关心的某个渲染目标。</p></div><p>我们后面会使用到 <code>depth_stencil_attachment</code>，现在先将它设置为 <code>None</code>。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>\n    view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>view<span class="token punctuation">,</span>\n    resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>\n    ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>\n        load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>\n            r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>\n            g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>\n            b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>\n            a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        store<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>RenderPassColorAttachment</code> 有一个 <code>view</code> 字段，用于通知 wgpu 将颜色保存到什么<strong>纹理</strong>。这里我们指定使用 <code>surface.get_current_texture()</code> 创建的 <code>view</code>，这意味着向此<strong>附件</strong>（Attachment）上绘制的任何颜色都会被绘制到屏幕上。</p><p><code>resolve_target</code> 是接收<strong>多重采样</strong>解析输出的纹理。除非启用了多重采样, 否则不需要设置它，保留为 <code>None</code> 即可。</p><p><code>ops</code> 字段需要一个 <code>wpgu::Operations</code> 对象。它告诉 wgpu 如何处理屏幕上的颜色（由 <code>view</code> 指定）。<code>load</code> 字段告诉 wgpu 如何处理存储在前一帧的颜色。目前，我们正在用蓝色<strong>清屏</strong>。<code>store</code> 字段告诉 wgpu 是否要将渲染的结果存储到<strong>纹理视图</strong>后面的纹理上（在这个例子中是 <code>SurfaceTexture</code> ）。我们希望存储渲染结果，所以设置为 <code>true</code>。</p><div class="note"><p>当屏幕被场景<strong>对象</strong>完全遮挡，那么不<strong>清屏</strong>是很常见的。但如果你的场景没有覆盖整个屏幕，就会出现类似下边的情况：</p><p><img src="'+t+'" alt="./no-clear.png"></p></div><h2 id="验证错误" tabindex="-1"><a class="header-anchor" href="#验证错误" aria-hidden="true">#</a> 验证错误?</h2>',45),Wn=(0,e.Uk)("如果你的机器上运行的是 Vulkan SDK 的旧版本， wgpu 在你的机器上使用 Vulkan 后端时可能会遇到"),Mn=(0,e._)("strong",null,"验证错误",-1),Hn=(0,e.Uk)("。至少需要使用 "),Kn=(0,e._)("code",null,"1.2.182",-1),Sn=(0,e.Uk)(" 及以上版本，因为旧版本可能会产生一些误报。如果错误持续存在，那可能是遇到了 wgpu 的错误。你可以在 "),Zn={href:"https://github.com/gfx-rs/wgpu",target:"_blank",rel:"noopener noreferrer"},Fn=(0,e.Uk)("https://github.com/gfx-rs/wgpu"),Vn=(0,e.Uk)(" 上提交此问题。"),Ln=(0,e._)("h2",{id:"挑战",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#挑战","aria-hidden":"true"},"#"),(0,e.Uk)(" 挑战")],-1),Gn=(0,e._)("p",null,[(0,e.Uk)("修改 "),(0,e._)("code",null,"input()"),(0,e.Uk)(" 函数以捕获鼠标事件，并使用该函数来更新"),(0,e._)("strong",null,"清屏"),(0,e.Uk)("的颜色。"),(0,e._)("em",null,[(0,e.Uk)("提示：你可能需要用到 "),(0,e._)("code",null,"WindowEvent::CursorMoved")]),(0,e.Uk)("。")],-1),jn={},Xn=(0,a(3744).Z)(jn,[["render",function(n,s){const a=(0,e.up)("ExternalLinkIcon"),t=(0,e.up)("WasmExample"),jn=(0,e.up)("AutoGithubLink");return(0,e.wg)(),(0,e.iD)("div",null,[p,(0,e._)("ul",null,[o,(0,e._)("li",null,[c,l,u,i,(0,e._)("a",A,[r,(0,e.Wm)(a)]),d])]),(0,e._)("div",k,[v,(0,e._)("p",null,[m,g,b,(0,e._)("a",f,[E,(0,e.Wm)(a)]),w])]),h,(0,e._)("p",null,[Q,C,(0,e._)("a",I,[y,(0,e.Wm)(a)]),B,U,_,q,R,O,z,D,P]),T,(0,e._)("div",J,[x,N,(0,e._)("p",null,[W,(0,e._)("a",M,[H,(0,e.Wm)(a)]),K])]),(0,e._)("p",null,[S,Z,(0,e._)("a",F,[V,(0,e.Wm)(a)]),L]),G,(0,e._)("p",null,[j,(0,e._)("a",X,[Y,(0,e.Wm)(a)]),$]),(0,e._)("div",nn,[(0,e._)("p",null,[sn,an,en,(0,e._)("a",tn,[pn,(0,e.Wm)(a)]),on,cn,ln]),un]),An,(0,e._)("p",null,[rn,dn,kn,vn,mn,(0,e._)("a",gn,[bn,(0,e.Wm)(a)]),fn,(0,e._)("a",En,[wn,(0,e.Wm)(a)]),hn,Qn,Cn,(0,e._)("a",In,[yn,(0,e.Wm)(a)]),Bn]),Un,(0,e._)("p",null,[_n,qn,Rn,On,zn,(0,e._)("a",Dn,[Pn,(0,e.Wm)(a)]),Tn,Jn,xn]),Nn,(0,e._)("p",null,[Wn,Mn,Hn,Kn,Sn,(0,e._)("a",Zn,[Fn,(0,e.Wm)(a)]),Vn]),Ln,Gn,(0,e.Wm)(t,{example:"tutorial2_surface"}),(0,e.Wm)(jn)])}]])}}]);