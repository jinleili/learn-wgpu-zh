<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>实例化绘制 | 学习 wgpu</title><meta name="description" content="使用 Rust 学习 wgpu">
    <link rel="preload" href="/learn-wgpu-zh/assets/js/runtime~app.1fe6cd89.js" as="script"><link rel="preload" href="/learn-wgpu-zh/assets/css/styles.dbd69ac3.css" as="style"><link rel="preload" href="/learn-wgpu-zh/assets/js/3866.84df6019.js" as="script"><link rel="preload" href="/learn-wgpu-zh/assets/js/app.986ad84b.js" as="script"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2d69bb60.97588166.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-bfc81dd6.ca69855e.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-4249d10f.bc14afad.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-82a25e06.afd792d8.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2168b6f4.5dbe9a23.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-1d87647f.2e51dd90.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-5ffceace.0ea5174c.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2c95ce4.1841b85e.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-5d0cc617.4c893ad3.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-e038f3ae.891ad23e.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-627538dd.7144e0a7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-220b0cd1.4e281037.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-64802336.ed141770.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-31840cac.b944bdc2.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b117cf7e.df64c42f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1162.d3408974.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/3475.032efde7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5883.33434865.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7937.6102c3bc.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-5c7d04cb.76f847da.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2307.5ea4c2d9.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/662.cc3b899d.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1426.b529462f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/381.efc9c7f6.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2277.af6d970b.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4970.7fbd9d88.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b3ccb192.bb89c06f.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5137.7bc11b24.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-0440027a.ea9c48bb.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-2b11540d.5346069c.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-1f0489a3.7877dd28.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-7db95cc0.a6ef9657.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-25d83dbe.bc1e6193.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/6321.6178d5b3.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5421.d43b8b02.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4839.56e336fd.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/416.643dde4e.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2922.e6dabe11.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4607.39e55359.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/1769.79e89645.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7854.355fb807.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/7255.d3f412ea.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/5734.e922f752.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/6402.ac52c68d.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/9292.16c9429c.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-0c308a02.7a030052.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-4a3d9733.3b589f04.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2a9f5e8.327e2006.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/4204.628e56a7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-6b60e296.9d3b6356.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-b2a9f626.e6bfd6fc.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-8daa1a0e.64603578.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-8b4c6ddc.774f09f7.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-745c8789.62149ac4.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/9944.09d39f9a.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-afc761bc.a3966cba.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/2076.ea11f7bb.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/v-3706649a.71b76089.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/js/75.8e0a872d.js"><link rel="prefetch" href="/learn-wgpu-zh/assets/css/8096.styles.d38597ea.css"><link rel="prefetch" href="/learn-wgpu-zh/assets/css/6681.styles.98ee24e7.css">
    <link rel="stylesheet" href="/learn-wgpu-zh/assets/css/styles.dbd69ac3.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/learn-wgpu-zh/" class=""><img class="logo" src="/learn-wgpu-zh/res/wgpu-logo.png" alt="学习 wgpu"><span class="site-name can-hide">学习 wgpu</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/learn-wgpu-zh/beginner/tutorial7-instancing/" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://sotrh.github.io/learn-wgpu/" rel="noopener noreferrer" target="_blank" aria-label="English"><!--[--><!--]--> English <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/jinleili/learn-wgpu-zh" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/learn-wgpu-zh/beginner/tutorial7-instancing/" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://sotrh.github.io/learn-wgpu/" rel="noopener noreferrer" target="_blank" aria-label="English"><!--[--><!--]--> English <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/jinleili/learn-wgpu-zh" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/learn-wgpu-zh/" class="sidebar-item sidebar-heading" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">基础 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/beginner/tutorial1-window/" class="sidebar-item" aria-label="依赖与窗口"><!--[--><!--]--> 依赖与窗口 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial2-surface/" class="sidebar-item" aria-label="展示平面 (Surface)"><!--[--><!--]--> 展示平面 (Surface) <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial3-pipeline/" class="sidebar-item" aria-label="管线 (Pipeline)"><!--[--><!--]--> 管线 (Pipeline) <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial4-buffer/" class="sidebar-item" aria-label="缓冲区与索引"><!--[--><!--]--> 缓冲区与索引 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial5-textures/" class="sidebar-item" aria-label="纹理和绑定组"><!--[--><!--]--> 纹理和绑定组 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial6-uniforms/" class="sidebar-item" aria-label="Uniform 缓冲区与 3D 虚拟摄像机"><!--[--><!--]--> Uniform 缓冲区与 3D 虚拟摄像机 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/beginner/tutorial7-instancing/" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="实例化绘制"><!--[--><!--]--> 实例化绘制 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/learn-wgpu-zh/beginner/tutorial7-instancing/#实例缓冲区" class="router-link-active router-link-exact-active sidebar-item" aria-label="实例缓冲区"><!--[--><!--]--> 实例缓冲区 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/learn-wgpu-zh/beginner/tutorial7-instancing/#挑战" class="router-link-active router-link-exact-active sidebar-item" aria-label="挑战"><!--[--><!--]--> 挑战 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/learn-wgpu-zh/beginner/tutorial8-depth/" class="sidebar-item" aria-label="深度缓冲区"><!--[--><!--]--> 深度缓冲区 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/beginner/tutorial9-models/" class="sidebar-item" aria-label="模型加载"><!--[--><!--]--> 模型加载 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">进阶 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/intermediate/tutorial10-lighting/" class="sidebar-item" aria-label="光照"><!--[--><!--]--> 光照 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/tutorial11-normals/" class="sidebar-item" aria-label="法线映射"><!--[--><!--]--> 法线映射 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/intermediate/tutorial12-camera/" class="sidebar-item" aria-label="更好的摄像机"><!--[--><!--]--> 更好的摄像机 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">集成与调试 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/integration-and-debugging/" class="sidebar-item" aria-label="楔子"><!--[--><!--]--> 楔子 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/integration-and-debugging/ios/" class="sidebar-item" aria-label="🆕 与 iOS App 集成"><!--[--><!--]--> 🆕 与 iOS App 集成 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/integration-and-debugging/android/" class="sidebar-item" aria-label="🆕 与 Android App 集成"><!--[--><!--]--> 🆕 与 Android App 集成 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/integration-and-debugging/xcode/" class="sidebar-item" aria-label="🆕 使用 Xcode 调试 wgpu 程序"><!--[--><!--]--> 🆕 使用 Xcode 调试 wgpu 程序 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/integration-and-debugging/snapdragon-profiler/" class="sidebar-item" aria-label="🆕 使用 Snapdragon Profiler 调试"><!--[--><!--]--> 🆕 使用 Snapdragon Profiler 调试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">案例展示 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/learn-wgpu-zh/showcase/windowless/" class="sidebar-item" aria-label="离屏渲染"><!--[--><!--]--> 离屏渲染 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/gifs/" class="sidebar-item" aria-label="生成 GIF 动图"><!--[--><!--]--> 生成 GIF 动图 <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/pong/" class="sidebar-item" aria-label="Pong"><!--[--><!--]--> Pong <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/compute/" class="sidebar-item" aria-label="Compute Example: Tangents and Bitangents"><!--[--><!--]--> Compute Example: Tangents and Bitangents <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/alignment/" class="sidebar-item" aria-label="Memory Layout in WGSL"><!--[--><!--]--> Memory Layout in WGSL <!--[--><!--]--></a><!----></li><li><a href="/learn-wgpu-zh/showcase/imgui-demo/" class="sidebar-item" aria-label="Basic Imgui Demo"><!--[--><!--]--> Basic Imgui Demo <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/learn-wgpu-zh/GLOSSARY_OF_TERMS.html" class="sidebar-item sidebar-heading" aria-label="术语中英对照表"><!--[--><!--]--> 术语中英对照表 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="实例化绘制" tabindex="-1"><a class="header-anchor" href="#实例化绘制" aria-hidden="true">#</a> 实例化绘制</h1><p>我们目前的场景非常简单：仅有一个以坐标 (0,0,0) 为中心的<strong>对象</strong>。如果想要绘制更多的对象呢？ 这，就是<strong>实例化绘制</strong>（Instancing）的用武之地了。</p><p><strong>实例化绘制</strong>允许我们以不同的属性（位置、方向、大小、颜色等）多次绘制同一个对象。有多种方式可以实现实例化绘制。其中一种方式是修改 Uniform 缓冲区以加入这些属性，并在绘制每个对象实例之前更新它。</p><p>出于性能原因，我们不推荐这种方式。因为逐<strong>实例</strong>更新时，uniform <strong>缓冲区</strong>需要为每一帧复制多个缓冲区而消耗 GPU 内存带宽, 且随实例数增加的绘制命令更是会消耗 GPU 的执行时间。</p><p>如果查阅 <a href="https://docs.rs/wgpu/latest/wgpu/struct.RenderPass.html#method.draw_indexed" target="_blank" rel="noopener noreferrer">wgpu 文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中 <code>draw_indexed</code> 函数的参数 ，我们可以看到解决这一问题的方式：</p><div class="language-rust= ext-rust= line-numbers-mode"><pre class="language-rust="><code>pub fn draw_indexed(
    &amp;mut self,
    indices: Range&lt;u32&gt;,
    base_vertex: i32,
    instances: Range&lt;u32&gt; // &lt;-- 在这里
)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>instances</code> 参数是<strong>范围</strong>（<code>Range&lt;u32&gt;</code>）类型的值。它命令 GPU 绘制指定对象的多少个实例。目前我们指定的是<code>0..1</code>，它命令 GPU 绘制 1 个实例后停止。如果使用 <code>0..5</code>，我们的代码就绘制 5 个实例。</p><p><code>instances</code> 的<strong>范围</strong>类型可能看起来很奇怪，因为使用 <code>1..2</code> 仍然是绘制 1 个实例。似乎直接使用 <code>u32</code> 类型会更简单，对吧？这里是<strong>范围</strong>类型的原因是：有时我们不想绘制出<em>所有</em>对象; 有时因为其他实例可能不该出现在这一<strong>帧</strong>中而只想绘制指定部分的实例; 又或者我们正在调试某组特定的实例。</p><p>好了，现在我们知道了如何绘制 1 个对象的多个实例，那么如何告诉 wgpu 要绘制哪些指定的实例呢？我们将要用到<strong>实例缓冲区</strong>（Instance Buffer）的概念。</p><h2 id="实例缓冲区" tabindex="-1"><a class="header-anchor" href="#实例缓冲区" aria-hidden="true">#</a> 实例缓冲区</h2><p>我们将以类似于创建 Uniform 缓冲区的方式创建一个<strong>实例缓冲区</strong>。首先，声明一个名为 <code>Instance</code> 的结构体：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// lib.rs</span>
<span class="token comment">// ...</span>

<span class="token comment">// 新增!</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Instance</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    rotation<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="note"><p><strong>四元数</strong>（Quaternion） 是一种通常用来表示旋转的数学结构。这里不会介绍它背后的数学原理（涉及<strong>虚数</strong>和 4 维空间）。如果你想深入了解四元数，这里有一篇 <a href="https://mathworld.wolfram.com/Quaternion.html" target="_blank" rel="noopener noreferrer">Wolfram Alpha<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的文章。</p></div><p>在<strong>着色器</strong>中直接使用这些值会有麻烦，因为 WGSL 里没有<strong>四元数</strong>的数据类型。我不想在着色器中做四元数运算，所以把 <code>Instance</code> 数据转换成了<strong>矩阵</strong>，并将其存储在一个名为 <code>InstanceRaw</code> 的结构体中：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 新增!</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这就是将要写入<strong>缓冲区</strong>的数据。我们拆分出 <code>InstanceRaw</code> 之后，就可以自由地更新 <code>Instance</code> 而无需涉及矩阵，因为 raw 数据只需要在绘制之前更新。</p><p>让我们在 <code>Instance</code> 上创建一个函数来计算并返回 <code>InstanceRaw</code>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 新增!</span>
<span class="token keyword">impl</span> <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">to_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
        <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from_translation</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在需要给 <code>State</code> 添加两个字段：<code>instances</code> 和 <code>instance_buffer</code>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    instances<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Instance</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>cgmath</code> <strong>包</strong>使用 trait 来为 <code>Vector3</code> 等类型提供通用的数学函数，这些 trait 必须在相关函数被调用之前导入。为了方便起见，包内的 <code>prelude</code> 模块在导入时就会提供一些常用的扩展 trait。</p><p>要导入 prelude 模块，只需把下边这行代码放在 <code>lib.rs</code> 的顶部：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">cgmath<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接下来在 <code>new()</code> 函数中创建实例数据，先定义几个<strong>常量</strong>用于简化代码：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">const</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们将创建一组 10 行 10 列空间排列均匀的实例数据，下边是具体代码：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>z<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> x <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> z <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token punctuation">}</span> <span class="token operator">-</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> rotation <span class="token operator">=</span> <span class="token keyword">if</span> position<span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 这一行特殊确保在坐标 (0, 0, 0) 处的对象不会被缩放到 0</span>
                    <span class="token comment">// 因为错误的四元数会影响到缩放</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">unit_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
                    position<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在数据已经有了，我们来创建实际的<strong>实例缓冲区</strong>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> instance_data <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Instance</span><span class="token punctuation">::</span>to_raw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Instance Buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contents<span class="token punctuation">:</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">VERTEX</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要为 <code>InstanceRaw</code> 创建一个新的<strong>顶点缓冲区布局</strong>：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span> <span class="token punctuation">{</span>
            array_stride<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">InstanceRaw</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
            <span class="token comment">// step_mode 的值需要从 Vertex 改为 Instance</span>
            <span class="token comment">// 这意味着只有着色器开始处理一次新实例化绘制时，才会使用下一个实例数据</span>
            step_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexStepMode</span><span class="token punctuation">::</span><span class="token class-name">Instance</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token comment">// 虽然顶点着色器现在只使用了插槽 0 和 1，但在后面的教程中将会使用 2、3 和 4</span>
                    <span class="token comment">// 此处从插槽 5 开始，确保与后面的教程不会有冲突</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// mat4 从技术的角度来看是由 4 个 vec4 构成，占用 4 个插槽。</span>
                <span class="token comment">// 我们需要为每个 vec4 定义一个插槽，然后在着色器中重新组装出 mat4。</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要将此<strong>布局</strong>添加到渲染<strong>管线</strong>中，以便在渲染时可以使用它：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    vertex<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexState</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 更新!</span>
        buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Vertex</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InstanceRaw</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>别忘了要返回新增的变量：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 新添加!</span>
    instances<span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后，在 <code>render()</code> 函数中绑定 <code>instance_buffer</code>，并修改 <code>draw_indexed()</code> 绘制命令以使用我们实际的实例数：</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 新添加!</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更新!</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="warning"><p>当你向<strong>数组</strong>添加新的实例时，请确保重新创建了 <code>instance_buffer</code> 和 <code>camera_bind_group</code>，否则新实例不会正确显示。</p></div><p><code>shader.wgsl</code> 中需要引入我们新增的<strong>矩阵</strong>，这样才能在实例中使用它。请在 <code>shader.wgsl</code> 文件的顶部添加以下代码：</p><div class="language-wgsl ext-wgsl line-numbers-mode"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">InstanceInput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">5</span><span class="token punctuation">)</span> model_matrix_0<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">6</span><span class="token punctuation">)</span> model_matrix_1<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">7</span><span class="token punctuation">)</span> model_matrix_2<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">8</span><span class="token punctuation">)</span> model_matrix_3<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在使用之前，我们需要将<strong>矩阵</strong>重新组装出来：</p><div class="language-wgsl ext-wgsl line-numbers-mode"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    model<span class="token punctuation">:</span> <span class="token class-name">VertexInput</span><span class="token punctuation">,</span>
    instance<span class="token punctuation">:</span> <span class="token class-name">InstanceInput</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> model_matrix <span class="token operator">=</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>model_matrix_0<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_1<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_2<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_3<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Continued...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们得在应用 <code>camera_uniform.view_proj</code> 之前先应用 <code>model_matrix</code>。因为 <code>view_proj</code> 将坐标系从<strong>世界空间</strong>（World Space）变换为<strong>相机空间</strong>（Camera Space），而 <code>model_matrix</code> 是一个<strong>世界空间</strong>的变换，所以在使用它时不希望处于<strong>相机空间</strong>。</p><div class="language-wgsl ext-wgsl line-numbers-mode"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    model<span class="token punctuation">:</span> <span class="token class-name">VertexInput</span><span class="token punctuation">,</span>
    instance<span class="token punctuation">:</span> <span class="token class-name">InstanceInput</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>tex_coords <span class="token operator">=</span> model<span class="token punctuation">.</span>tex_coords<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>view_proj <span class="token operator">*</span> model_matrix <span class="token operator">*</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>position<span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成后，应该就能看到一片树林了！</p><p><img src="/learn-wgpu-zh/assets/img/forest.ceafb445.png" alt="./forest.png"></p><h2 id="挑战" tabindex="-1"><a class="header-anchor" href="#挑战" aria-hidden="true">#</a> 挑战</h2><p>逐帧变更实例的位置 和/或 旋转弧度。</p><div id="wasm-example"><!----><button>Try Tutorial7_instancing!</button></div><div class="auto-github-link"><a href="https://github.com/jinleili/learn-wgpu-zh/tree/master/code/beginner/tutorial7-instancing/" target="_blank" rel="noopener noreferrer"> &quot;查看源码！&quot; </a><!----></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/learn-wgpu-zh/beginner/tutorial6-uniforms/" class="" aria-label="Uniform 缓冲区与 3D 虚拟摄像机"><!--[--><!--]--> Uniform 缓冲区与 3D 虚拟摄像机 <!--[--><!--]--></a></span><span class="next"><a href="/learn-wgpu-zh/beginner/tutorial8-depth/" class="" aria-label="深度缓冲区"><!--[--><!--]--> 深度缓冲区 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/learn-wgpu-zh/assets/js/runtime~app.1fe6cd89.js" defer></script><script src="/learn-wgpu-zh/assets/js/3866.84df6019.js" defer></script><script src="/learn-wgpu-zh/assets/js/app.986ad84b.js" defer></script>
  </body>
</html>
